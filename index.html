<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#f0f8ff">
<title>🌧️ 香港降雨預報</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 { font-size: 1.4em; margin: 1em 0 0.5em; }
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#ai-forecast {
margin: 1em;
padding: 1em;
border: 2px solid #0077cc;
border-radius: 8px;
background: #fff;
text-align: left;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
line-height: 1.8em;
white-space: pre-line;
}
#footer-text {
margin: 1.5em;
font-size: 0.9em;
color: #555;
line-height: 1.6em;
}
.promptBox {
position: fixed;
bottom: 20px;
left: 10%;
right: 10%;
background: #fff3cd;
color: #333;
border: 1px solid #ffeeba;
padding: 15px;
border-radius: 10px;
font-size: 0.95em;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
z-index: 9999;
}
.promptBox button {
margin-top: 10px;
padding: 6px 12px;
background: #0077cc;
color: white;
border: none;
border-radius: 5px;
}
</style>

<!-- 🔔 PWA 設定 -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="香港降雨預報">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- 🔔 OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" async></script>
<script>
// ✅ 確保 Service Worker 先註冊，然後再初始化 OneSignal
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('/onesignal-sw.js', { scope: '/' })
.then(() => {
console.log('📱 Service Worker 已註冊完成');
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
notifyButton: { enable: true },
allowLocalhostAsSecureOrigin: true
});
console.log("✅ OneSignal 已初始化");

<script>
navigator.geolocation.getCurrentPosition(pos => {
const { latitude, longitude } = pos.coords;
OneSignal.getUserId().then(pid => {
fetch("https://crowdtest8r.ctakwah.workers.dev/registerLocation", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ playerId: pid, lat: latitude, lon: longitude })
});
});
});
</script>

// 🔍 訂閱變化監控
OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
if (event.to.isSubscribed) {
const playerId = await OneSignal.User.PushSubscription.id;
if (playerId) {
localStorage.setItem("playerId", playerId);
console.log("✅ Player ID 已儲存：", playerId);
}
}
});

try {
const currentId = await OneSignal.User.PushSubscription.id;
if (currentId) {
localStorage.setItem("playerId", currentId);
console.log("🎯 已偵測現有 Player ID：", currentId);
}
} catch (err) {
console.error("❌ 取得 Player ID 時發生錯誤：", err);
}
});
})
.catch(err => console.warn('⚠️ 無法註冊 Service Worker', err));
} else {
console.warn("❌ 此瀏覽器不支援 Service Worker");
}

// ✅ 自動提示用戶開啟通知
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(function(OneSignal) {
OneSignal.Slidedown.promptPush();
});
</script>
</head>

<body>
<h1>🌂 香港降雨預報</h1>
<div id="map"></div>

<div id="ai-forecast">
<strong>🧠 AI 超前預測</strong>
<div id="rainMsg">⏳ 正在載入...</div>
</div>

<div id="rain-alert">⏳ 正在讀取預報資料...</div>

<!-- 全裝置共用提示框 -->
<div id="customPrompt" class="promptBox" style="display:none;">
📢 歡迎使用《香港降雨預報》<br>
👉 你可以訂閱通知，即時收到降雨提示。<br>
<button id="subscribeBtn">訂閱通知</button>
<button id="closeCustomBtn">稍後再說</button>
</div>

<!-- iOS 專屬提示框 -->
<div id="iosPrompt" class="promptBox" style="display:none;">
📱 如果你用 iPhone / iPad：<br>
請先按 Safari 底部的 <b>分享</b> 按鈕 <br>
➜ 再揀 <b>加入主畫面</b> 才可收到推播通知。<br>
<button id="iosCloseBtn">知道了</button>
</div>

<div id="footer-text">
<p style="text-align:left;margin-bottom:1.5em;">
本網站提供香港未來最多三小時內定點的降雨預測，用戶可即時得知身處地點的降雨情況。
</p>
<p style="text-align:left;margin-bottom:1.5em;">
資料來源：香港天文台 / Tomorrow.io (AI 超前預測)
</p>
<p style="text-align:left;">網站功能將不斷更新，敬請留意</p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest8r.ctakwah.workers.dev/';
const TOMORROW_API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";
let marker, rainStatus = 0;

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
if (data && typeof data.immediateRain === "number") {
if (data.immediateRain > 0.01) {
alertDiv.innerText = `⚠️ 即時預報：你所在的位置將會有雨`;
if (rainStatus === 0) {
speak("⚠️ 你所在的位置將會有雨");
sendPush();
rainStatus = 1;
}
} else {
alertDiv.innerText = `☁️ 你所在的位置暫時無雨`;
rainStatus = 0;
}
} else {
alertDiv.innerText = "⚠️ 系統繁忙，請稍後再試";
}
});
}
.catch(err => {
console.error("讀取預報錯誤", err);
document.getElementById('rain-alert').innerText = "⚠️ 系統繁忙，請稍後再試";
});
}

function fetchTomorrowAI(lat, lon) {
fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1m&endTime=+180m&apikey=${TOMORROW_API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180);
const rains = minutes.map(m => m.values.rainIntensity);
let msg = "當降雨前一至三小時內會提供相關訊息";
const rains1to3h = rains.slice(60, 180);
const overThreshold = rains1to3h.some(r => r >= 1.0);
if (overThreshold) msg = "🌧 你所在的位置預計約兩小時內有雨";
document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "⚠️ 系統繁忙，請稍後再試");
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

function sendPush(lat, lon) {
const playerId = localStorage.getItem("playerId") || "";
fetch(workerUrl + "sendPush", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
title: "⚠️ 降雨提示",
message: `你所在 (${lat.toFixed(3)}, ${lon.toFixed(3)}) 將會有雨`,
playerId: playerId,
url: location.href
})
});
}

function initLocation() {
if (!navigator.geolocation) {
alert("此瀏覽器不支援定位功能");
const fallbackLat = 22.3, fallbackLon = 114.2;
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
return;
}
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude, lon = pos.coords.longitude;
map.setView([lat, lon], 13);
setMarker(lat, lon);
fetchForecast(lat, lon);
fetchTomorrowAI(lat, lon);
},
err => {
console.warn("⚠️ 定位失敗");
const fallbackLat = 22.3, fallbackLon = 114.2;
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
},
{ enableHighAccuracy: true }
);
}

function showIosPromptOnce() {
if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && !localStorage.getItem("iosPromptShown")) {
document.getElementById("iosPrompt").style.display = "block";
document.getElementById("iosCloseBtn").onclick = function() {
document.getElementById("iosPrompt").style.display = "none";
localStorage.setItem("iosPromptShown", "1");
};
}
}

function showCustomPrompt() {
if (localStorage.getItem("subscribedToRainAlert")) return;
document.getElementById("customPrompt").style.display = "block";
document.getElementById("subscribeBtn").onclick = function() {
OneSignal.push(() => OneSignal.showNativePrompt());
document.getElementById("customPrompt").style.display = "none";
localStorage.setItem("subscribedToRainAlert", "1");
};
document.getElementById("closeCustomBtn").onclick = function() {
document.getElementById("customPrompt").style.display = "none";
};
}

initLocation();
showIosPromptOnce();
showCustomPrompt();
</script>
</body>
</html>