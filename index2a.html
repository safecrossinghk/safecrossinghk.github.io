<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#f0f8ff">
<title>🌧️ 香港降雨預報</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 {
font-size: 1.4em;
margin: 1em 0 0.5em;
}
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#ai-forecast {
margin: 1em;
padding: 1em;
border: 2px solid #0077cc;
border-radius: 8px;
background: #fff;
text-align: left;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
line-height: 1.8em;
white-space: pre-line;
}
#footer-text {
margin: 1.5em;
font-size: 0.9em;
color: #555;
line-height: 1.6em;
}
.promptBox {
position: fixed;
bottom: 20px;
left: 10%;
right: 10%;
background: #fff3cd;
color: #333;
border: 1px solid #ffeeba;
padding: 15px;
border-radius: 10px;
font-size: 0.95em;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
z-index: 9999;
}
.promptBox button {
margin-top: 10px;
padding: 6px 12px;
background: #0077cc;
color: white;
border: none;
border-radius: 5px;
}
</style>

<!-- 🔔 PWA 設定 -->
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="no">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="香港降雨預報">

<!-- 🔔 OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
serviceWorkerPath: "/OneSignalSDKWorker.js" // ✅ 根目錄
});
});
</script>
</head>

<body>
<h1>🌂 香港降雨預報</h1>
<div id="map"></div>

<!-- AI 超前預測 -->
<div id="ai-forecast">
<strong>🧠 AI 超前預測</strong>
<div id="rainMsg">⏳ 正在載入...</div>
</div>

<div id="rain-alert">⏳ 正在讀取預報資料...</div>

<!-- 全裝置共用提示框 -->
<div id="customPrompt" class="promptBox" style="display:none;">
📢 歡迎使用《香港降雨預報》<br>
👉 你可以訂閱通知，即時收到降雨提示。<br>
<button id="subscribeBtn">訂閱通知</button>
<button id="closeCustomBtn">稍後再說</button>
</div>

<!-- iOS 專屬提示框 -->
<div id="iosPrompt" class="promptBox" style="display:none;">
📱 如果你用 iPhone / iPad：<br>
請先按 Safari 底部的 <b>分享</b> 按鈕 <br>
➜ 再揀 <b>加入主畫面</b> 才可收到推播通知。<br>
<button id="iosCloseBtn">知道了</button>
</div>

<!-- 文末三句 -->
<div id="footer-text">
<p style="text-align: left; margin-bottom: 1.5em;">
本網站提供香港未來最多三小時內定點的降雨預測，用戶可即時得知身處地點的降雨情況。
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
資料來源：香港天文台 / Tomorrow.io (AI 超前預測)
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
- 用戶請先允許定位服務
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
- 預報在某些情況可能會出現誤差
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
網站功能將不斷更新，敬請留意
</p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest8r.ctakwah.workers.dev/';
const TOMORROW_API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker;
let rainStatus = 0;

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

// 🟢 OneSignal 自動推播封裝
function sendPush(title, message) {
if (window.OneSignal) {
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.sendSelfNotification({
title: title,
message: message,
icon: "https://safecrossinghk.github.io/icon-192.png",
url: "https://safecrossinghk.github.io/index2a.html"
});
console.log("✅ OneSignal 本地推播已觸發");
});
}
}

// 🟡 天文台即時預報
function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
console.log("API 回傳資料：", data);

if (data && typeof data.immediateRain === "number") {
if (data.immediateRain > 0.01) {
alertDiv.innerText = `⚠️ 即時預報：你所在的位置將會有雨`;
if (rainStatus === 0) {
speak("⚠️ 你所在的位置將會有雨");
sendPush("⚠️ 降雨提示", "你所在的位置將會有雨");
rainStatus = 1;
}
} else {
alertDiv.innerText = `☁️ 你所在的位置暫時無雨`;
rainStatus = 0;
}
} else {
alertDiv.innerText = "⚠️ 系統繁忙，請稍後再試";
}
})
.catch(err => {
console.error("讀取預報錯誤", err);
document.getElementById('rain-alert').innerText = "⚠️ 系統繁忙，請稍後再試";
});
}

// 🔵 Tomorrow.io AI 預報
function fetchTomorrowAI(lat, lon) {
fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1m&endTime=+180m&apikey=${TOMORROW_API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180);
const rains = minutes.map(m => m.values.rainIntensity);

let msg = "當降雨前一至三小時內會提供相關訊息";
let triggered1 = false;
let triggered2 = false;

const rains1to3h = rains.slice(60, 180);
const overThreshold1to3h = rains1to3h.some(r => r >= 1.0);

let hasRising = false;
let risingMinute = -1;
for (let i = 61; i < 180; i++) {
if (rains[i] > rains[i - 1] && rains[i] >= 1.0) {
hasRising = true;
risingMinute = i;
break;
}
}

if (overThreshold1to3h && hasRising) {
triggered1 = true;
if (risingMinute <= 60) msg = `🌧 你所在的位置預計約一小時內有雨`;
else if (risingMinute <= 120) msg = `🌧 你所在的位置預計約兩小時內有雨`;
else msg = `🌧 你所在的位置預計約三小時內有雨`;
}

if (!triggered1) {
for (let start = 0; start <= rains.length - 30; start++) {
const window = rains.slice(start, start + 30);
const maxVal = Math.max(...window);
const minVal = Math.min(...window);
if (maxVal - minVal <= 0.5 && maxVal >= 1.0) {
triggered2 = true;
msg = `🌧 你所在的位置預計約三小時內有雨`;
break;
}
}
}
document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "⚠️ 系統繁忙，請稍後再試");
}

// 🔊 語音播放
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

// 📍 定位初始化
function initLocation() {
if (!navigator.geolocation) {
alert("此瀏覽器不支援定位功能");
const fallbackLat = 22.3, fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
return;
}
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
console.log("✅ 取得定位：", lat, lon);
map.setView([lat, lon], 13);
setMarker(lat, lon);
fetchForecast(lat, lon);
fetchTomorrowAI(lat, lon);
},
err => {
console.warn("⚠️ 定位失敗，使用預設位置");
const fallbackLat = 22.3, fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
},
{ enableHighAccuracy: true }
);
}

// 🧠 提示框邏輯
function showIosPromptOnce() {
if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
if (!localStorage.getItem("iosPromptShown")) {
document.getElementById("iosPrompt").style.display = "block";
document.getElementById("iosCloseBtn").onclick = function() {
document.getElementById("iosPrompt").style.display = "none";
localStorage.setItem("iosPromptShown", "1");
};
}
}
}

function showCustomPrompt() {
if (localStorage.getItem("subscribedToRainAlert")) return;
document.getElementById("customPrompt").style.display = "block";
document.getElementById("subscribeBtn").onclick = function() {
OneSignal.push(function() {
OneSignal.showNativePrompt();
});
document.getElementById("customPrompt").style.display = "none";
localStorage.setItem("subscribedToRainAlert", "1");
};
document.getElementById("closeCustomBtn").onclick = function() {
document.getElementById("customPrompt").style.display = "none";
};
}

initLocation();
showIosPromptOnce();
showCustomPrompt();
</script>
</body>
</html>