<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#f0f8ff">
<title>ğŸŒ§ï¸ é¦™æ¸¯é™é›¨é å ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 { font-size: 1.4em; margin: 1em 0 0.5em; }
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#ai-forecast {
margin: 1em;
padding: 1em;
border: 2px solid #0077cc;
border-radius: 8px;
background: #fff;
text-align: left;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
line-height: 1.8em;
white-space: pre-line;
}
#footer-text {
margin: 1.5em;
font-size: 0.9em;
color: #555;
line-height: 1.6em;
}
.promptBox {
position: fixed;
bottom: 20px;
left: 10%;
right: 10%;
background: #fff3cd;
color: #333;
border: 1px solid #ffeeba;
padding: 15px;
border-radius: 10px;
font-size: 0.95em;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
z-index: 9999;
}
.promptBox button {
margin-top: 10px;
padding: 6px 12px;
background: #0077cc;
color: white;
border: none;
border-radius: 5px;
}
</style>

<!-- ğŸ”” PWA è¨­å®š -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="é¦™æ¸¯é™é›¨é å ±">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- ğŸ”” OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" async></script>
<script>
// âœ… ç¢ºä¿ Service Worker å…ˆè¨»å†Šï¼Œç„¶å¾Œå†åˆå§‹åŒ– OneSignal
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('/onesignal-sw.js', { scope: '/' })
.then(() => {
console.log('ğŸ“± Service Worker å·²è¨»å†Šå®Œæˆ');
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
notifyButton: { enable: true },
allowLocalhostAsSecureOrigin: true
});
console.log("âœ… OneSignal å·²åˆå§‹åŒ–");

<script>
navigator.geolocation.getCurrentPosition(pos => {
const { latitude, longitude } = pos.coords;
OneSignal.getUserId().then(pid => {
fetch("https://crowdtest8r.ctakwah.workers.dev/registerLocation", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ playerId: pid, lat: latitude, lon: longitude })
});
});
});
</script>

// ğŸ” è¨‚é–±è®ŠåŒ–ç›£æ§
OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
if (event.to.isSubscribed) {
const playerId = await OneSignal.User.PushSubscription.id;
if (playerId) {
localStorage.setItem("playerId", playerId);
console.log("âœ… Player ID å·²å„²å­˜ï¼š", playerId);
}
}
});

try {
const currentId = await OneSignal.User.PushSubscription.id;
if (currentId) {
localStorage.setItem("playerId", currentId);
console.log("ğŸ¯ å·²åµæ¸¬ç¾æœ‰ Player IDï¼š", currentId);
}
} catch (err) {
console.error("âŒ å–å¾— Player ID æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
}
});
})
.catch(err => console.warn('âš ï¸ ç„¡æ³•è¨»å†Š Service Worker', err));
} else {
console.warn("âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Service Worker");
}

// âœ… è‡ªå‹•æç¤ºç”¨æˆ¶é–‹å•Ÿé€šçŸ¥
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(function(OneSignal) {
OneSignal.Slidedown.promptPush();
});
</script>
</head>

<body>
<h1>ğŸŒ‚ é¦™æ¸¯é™é›¨é å ±</h1>
<div id="map"></div>

<div id="ai-forecast">
<strong>ğŸ§  AI è¶…å‰é æ¸¬</strong>
<div id="rainMsg">â³ æ­£åœ¨è¼‰å…¥...</div>
</div>

<div id="rain-alert">â³ æ­£åœ¨è®€å–é å ±è³‡æ–™...</div>

<!-- å…¨è£ç½®å…±ç”¨æç¤ºæ¡† -->
<div id="customPrompt" class="promptBox" style="display:none;">
ğŸ“¢ æ­¡è¿ä½¿ç”¨ã€Šé¦™æ¸¯é™é›¨é å ±ã€‹<br>
ğŸ‘‰ ä½ å¯ä»¥è¨‚é–±é€šçŸ¥ï¼Œå³æ™‚æ”¶åˆ°é™é›¨æç¤ºã€‚<br>
<button id="subscribeBtn">è¨‚é–±é€šçŸ¥</button>
<button id="closeCustomBtn">ç¨å¾Œå†èªª</button>
</div>

<!-- iOS å°ˆå±¬æç¤ºæ¡† -->
<div id="iosPrompt" class="promptBox" style="display:none;">
ğŸ“± å¦‚æœä½ ç”¨ iPhone / iPadï¼š<br>
è«‹å…ˆæŒ‰ Safari åº•éƒ¨çš„ <b>åˆ†äº«</b> æŒ‰éˆ• <br>
âœ å†æ€ <b>åŠ å…¥ä¸»ç•«é¢</b> æ‰å¯æ”¶åˆ°æ¨æ’­é€šçŸ¥ã€‚<br>
<button id="iosCloseBtn">çŸ¥é“äº†</button>
</div>

<div id="footer-text">
<p style="text-align:left;margin-bottom:1.5em;">
æœ¬ç¶²ç«™æä¾›é¦™æ¸¯æœªä¾†æœ€å¤šä¸‰å°æ™‚å…§å®šé»çš„é™é›¨é æ¸¬ï¼Œç”¨æˆ¶å¯å³æ™‚å¾—çŸ¥èº«è™•åœ°é»çš„é™é›¨æƒ…æ³ã€‚
</p>
<p style="text-align:left;margin-bottom:1.5em;">
è³‡æ–™ä¾†æºï¼šé¦™æ¸¯å¤©æ–‡å° / Tomorrow.io (AI è¶…å‰é æ¸¬)
</p>
<p style="text-align:left;">ç¶²ç«™åŠŸèƒ½å°‡ä¸æ–·æ›´æ–°ï¼Œæ•¬è«‹ç•™æ„</p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest8r.ctakwah.workers.dev/';
const TOMORROW_API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";
let marker, rainStatus = 0;

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
if (data && typeof data.immediateRain === "number") {
if (data.immediateRain > 0.01) {
alertDiv.innerText = `âš ï¸ å³æ™‚é å ±ï¼šä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨`;
if (rainStatus === 0) {
speak("âš ï¸ ä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨");
sendPush();
rainStatus = 1;
}
} else {
alertDiv.innerText = `â˜ï¸ ä½ æ‰€åœ¨çš„ä½ç½®æš«æ™‚ç„¡é›¨`;
rainStatus = 0;
}
} else {
alertDiv.innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
}
});
}
.catch(err => {
console.error("è®€å–é å ±éŒ¯èª¤", err);
document.getElementById('rain-alert').innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
});
}

function fetchTomorrowAI(lat, lon) {
fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1m&endTime=+180m&apikey=${TOMORROW_API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180);
const rains = minutes.map(m => m.values.rainIntensity);
let msg = "ç•¶é™é›¨å‰ä¸€è‡³ä¸‰å°æ™‚å…§æœƒæä¾›ç›¸é—œè¨Šæ¯";
const rains1to3h = rains.slice(60, 180);
const overThreshold = rains1to3h.some(r => r >= 1.0);
if (overThreshold) msg = "ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„å…©å°æ™‚å…§æœ‰é›¨";
document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦");
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

function sendPush(lat, lon) {
const playerId = localStorage.getItem("playerId") || "";
fetch(workerUrl + "sendPush", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
title: "âš ï¸ é™é›¨æç¤º",
message: `ä½ æ‰€åœ¨ (${lat.toFixed(3)}, ${lon.toFixed(3)}) å°‡æœƒæœ‰é›¨`,
playerId: playerId,
url: location.href
})
});
}

function initLocation() {
if (!navigator.geolocation) {
alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
const fallbackLat = 22.3, fallbackLon = 114.2;
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
return;
}
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude, lon = pos.coords.longitude;
map.setView([lat, lon], 13);
setMarker(lat, lon);
fetchForecast(lat, lon);
fetchTomorrowAI(lat, lon);
},
err => {
console.warn("âš ï¸ å®šä½å¤±æ•—");
const fallbackLat = 22.3, fallbackLon = 114.2;
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
},
{ enableHighAccuracy: true }
);
}

function showIosPromptOnce() {
if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && !localStorage.getItem("iosPromptShown")) {
document.getElementById("iosPrompt").style.display = "block";
document.getElementById("iosCloseBtn").onclick = function() {
document.getElementById("iosPrompt").style.display = "none";
localStorage.setItem("iosPromptShown", "1");
};
}
}

function showCustomPrompt() {
if (localStorage.getItem("subscribedToRainAlert")) return;
document.getElementById("customPrompt").style.display = "block";
document.getElementById("subscribeBtn").onclick = function() {
OneSignal.push(() => OneSignal.showNativePrompt());
document.getElementById("customPrompt").style.display = "none";
localStorage.setItem("subscribedToRainAlert", "1");
};
document.getElementById("closeCustomBtn").onclick = function() {
document.getElementById("customPrompt").style.display = "none";
};
}

initLocation();
showIosPromptOnce();
showCustomPrompt();
</script>
</body>
</html>