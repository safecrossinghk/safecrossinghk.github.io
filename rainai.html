<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é¦™æ¸¯ AI é™é›¨é å ± Demoï¼ˆMetNetâ€‘3 + HKO CSVï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header, footer { padding: 8px 12px; }
    header { background: #0f172a; color: #fff; }
    footer { background: #f1f5f9; font-size: 12px; color: #334155; }
    #map { height: 100%; }
    .panel { position:absolute; top:70px; left:12px; background:#ffffffdd; padding:10px 12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); }
    .legend { display:flex; gap:6px; align-items:center; }
    .swatch { width:16px; height:10px; display:inline-block; }
    .controls { display:flex; gap:12px; align-items:center; }
    .badge { padding:2px 6px; border-radius:6px; background:#e2e8f0; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <div><strong>é¦™æ¸¯ AI é™é›¨é å ± Demo</strong> <span class="badge">0â€“6 å°æ™‚</span></div>
      <div>MetNetâ€‘3 + HKO CSV + SWIRLSï¼ˆèåˆç¤ºæ„ï¼‰</div>
    </div>
  </header>
  <div id="map"></div>
  <footer>
    æç¤ºï¼šæ­¤ç‚ºé›¢ç·šå‡è³‡æ–™ Demoï¼Œå±•ç¤ºèåˆèˆ‡ UI è¡Œç‚ºã€‚å¯¦ä½œæ™‚æ”¹ç‚º Worker ç«¯é»ï¼š
    <code>/nowcast?lat&lon</code>ã€<code>/tile/{z}/{x}/{y}</code>ã€<code>/alerts</code>
  </footer>
</div>

<div class="panel">
  <div class="controls">
    <label for="lead">é å ±æ™‚æ•ˆï¼ˆå°æ™‚ï¼‰</label>
    <input type="range" id="lead" min="0" max="6" value="0">
    <span id="leadLabel" class="badge">0 h</span>
    <button id="play">â–¶ï¸ æ’­æ”¾</button>
    <button id="speak">ğŸ”Š èªéŸ³æ’­å ±</button>
  </div>
  <div style="margin-top:8px;" class="legend">
    <span>é™é›¨å¼·åº¦ï¼š</span>
    <span class="swatch" style="background:#d0f0ff"></span>å¼±
    <span class="swatch" style="background:#66b3ff"></span>ä¸­
    <span class="swatch" style="background:#0066ff"></span>å¤§
    <span class="swatch" style="background:#001a66"></span>æš´é›¨
  </div>
  <div id="alert" style="margin-top:8px;"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ------ åœ°åœ–åˆå§‹åŒ–ï¼ˆé¦™æ¸¯ç¯„åœï¼‰ ------
const map = L.map('map').setView([22.32, 114.17], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// ä¸€äº›ä»£è¡¨æ€§åœ°å€ï¼ˆè¿‘ä¼¼ä¸­å¿ƒé»ï¼‰
const regions = [
  {name:'æ¸¯å³¶', lat:22.278, lon:114.158},
  {name:'ä¹é¾', lat:22.321, lon:114.169},
  {name:'æ–°ç•Œè¥¿', lat:22.372, lon:114.045},
  {name:'æ–°ç•Œæ±', lat:22.445, lon:114.225},
  {name:'å¤§å¶¼å±±', lat:22.27, lon:113.95}
];

// ------ å‡è³‡æ–™ç”Ÿæˆï¼ˆæ¨¡æ“¬ MetNet èˆ‡ HKO CSV èåˆï¼‰ ------
// å¼·åº¦ mm/hr 0-80ï¼›å‰ 0â€“2h åå‘ HKOï¼ˆæ›´æ¥µç«¯ï¼‰ï¼Œ2â€“6h åå‘ MetNetï¼ˆæ›´å¹³æ»‘ï¼‰
function generateData(seed=1){
  const data = [];
  for(let h=0; h<=6; h++){
    const t = h/6;
    data[h] = regions.map((r,i)=>{
      const base = 20 + 25*Math.sin((i+1)*1.1 + h*0.7) + 10*Math.cos((i+1)*0.9 - h*0.5);
      let hko = Math.max(0, base + 25*Math.sin(h*2+i));      // æ›´åŠ‡çƒˆæ³¢å‹•
      let met = Math.max(0, base * 0.8 + 8);                 // è¼ƒå¹³æ»‘
      const w = (h<=2) ? 0.7 : 0.3;                          // 0â€“2h å HKOï¼Œä¹‹å¾Œå MetNet
      const mmph = w*hko + (1-w)*met;
      return { ...r, mmph: Math.min(80, Math.max(0, mmph)) };
    });
  }
  return data;
}
const fused = generateData();

// è‘—è‰²å‡½å¼
function colorScale(v){
  if (v >= 50) return '#001a66';   // æš´é›¨
  if (v >= 30) return '#0066ff';   // å¤§
  if (v >= 15) return '#66b3ff';   // ä¸­
  return '#d0f0ff';                // å¼±
}

// åœ–å±¤å®¹å™¨
const layerGroup = L.layerGroup().addTo(map);

// ç¹ªè£½ç•¶å‰æ™‚æ•ˆ
function drawHour(h){
  layerGroup.clearLayers();
  fused[h].forEach(d=>{
    const radius = Math.min(4000, 800 + d.mmph*40);
    L.circle([d.lat,d.lon], {radius, color: colorScale(d.mmph), fillColor: colorScale(d.mmph), fillOpacity:0.35, weight:1})
      .bindTooltip(`${d.name}ï¼š${d.mmph.toFixed(0)} mm/hr`)
      .addTo(layerGroup);
  });
  document.getElementById('leadLabel').textContent = `${h} h`;
  renderAlert(h);
}

function renderAlert(h){
  const a = document.getElementById('alert');
  const kowloon = fused[h].find(x=>x.name==='ä¹é¾').mmph;
  let level = null;
  if (kowloon >= 70) level = 'é»‘é›¨ï¼ˆ>70 mm/hrï¼‰';
  else if (kowloon >= 50) level = 'ç´…é›¨ï¼ˆ>50 mm/hrï¼‰';
  else if (kowloon >= 30) level = 'é»ƒé›¨ï¼ˆ>30 mm/hrï¼‰';
  a.innerHTML = level ? `<strong>âš ï¸ ${level}</strong>  æ–¼ä¹é¾ï¼Œ${h} å°æ™‚å¾Œ` : 'â€”';
}

// èªéŸ³æ’­å ±
function speak(h){
  const s = window.speechSynthesis;
  if (!s) return;
  const kowloon = fused[h].find(x=>x.name==='ä¹é¾').mmph.toFixed(0);
  const u = new SpeechSynthesisUtterance(`é å ± ${h} å°æ™‚å¾Œï¼Œä¹é¾é™é›¨ç‡ç´„æ¯å°æ™‚ ${kowloon} æ¯«ç±³ã€‚`);
  u.lang = 'zh-HK';
  s.cancel(); s.speak(u);
}

// äº¤äº’
const lead = document.getElementById('lead');
lead.addEventListener('input', e=> drawHour(Number(e.target.value)));

// æ’­æ”¾
let timer=null;
document.getElementById('play').onclick = ()=>{
  if (timer){ clearInterval(timer); timer=null; return; }
  let h = Number(lead.value);
  timer = setInterval(()=>{
    h = (h+1)%7; lead.value=h; drawHour(h);
  }, 1200);
};

document.getElementById('speak').onclick = ()=> speak(Number(lead.value));

// åˆå§‹é¡¯ç¤º
drawHour(0);
</script>
</html>