<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>æœªä¾†é™é›¨æç¤º</title>
</head>
<body>
<div id="rainMsg"></div>

<script>
const API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";
const LAT = 22.3, LON = 114.2; // é¦™æ¸¯åº§æ¨™
const THRESHOLD = 1.0; // é–€æª» 1 mm/hr

fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${LAT},${LON}&timesteps=1m&endTime=+180m&apikey=${API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180); // 0â€“3å°æ™‚å…±180åˆ†é˜
const rains = minutes.map(m => m.values.rainIntensity);

console.log("ğŸ” é€åˆ†é˜é›¨é‡ (0â€“3h):", rains);

let msg = "æš«æ™‚æœªè¦‹éœ€è¦æç¤ºã€‚";
let triggered1 = false;
let triggered2 = false;

// -------- æ¢ä»¶1: 1â€“3å°æ™‚å…§ â‰¥1 ä¸”æœ‰ä¸Šå‡ --------
const rains1to3h = rains.slice(60, 180); // 1â€“3å°æ™‚ (60â€“180åˆ†é˜)
const overThreshold1to3h = rains1to3h.some(r => r >= THRESHOLD);

let hasRising = false;
let risingMinute = -1;
let risingTime = "";
for (let i = 61; i < 180; i++) {
if (rains[i] > rains[i - 1] && rains[i] >= THRESHOLD) {
hasRising = true;
risingMinute = i;
risingTime = new Date(minutes[i].time).toLocaleTimeString("zh-HK", { hour: "2-digit", minute: "2-digit" });
break;
}
}

if (overThreshold1to3h && hasRising) {
triggered1 = true;
const minutesLater = risingMinute; // å¹¾å¤šåˆ†é˜å¾Œ
if (risingMinute <= 60) {
msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸€å°æ™‚å…§æœ‰é›¨`;
} else if (risingMinute <= 120) {
msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„å…©å°æ™‚å…§æœ‰é›¨`;
} else {
msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸‰å°æ™‚å…§æœ‰é›¨`;
}
console.log("âœ… æ¢ä»¶1è§¸ç™¼ â†’ risingMinute:", risingMinute, " risingTime:", risingTime, " msg:", msg);
}

// -------- æ¢ä»¶2: 0â€“3å°æ™‚å…§æœ‰é€£çºŒ30åˆ†é˜ â‰¥1 ä¸”æ³¢å¹… â‰¤0.5 --------
if (!triggered1) { // âœ… æ¢ä»¶1å„ªå…ˆï¼Œè‹¥æœªè§¸ç™¼æ‰æª¢æŸ¥æ¢ä»¶2
let hasStable30min = false;
let stableStart = -1;
let stableTime = "";
for (let start = 0; start <= rains.length - 30; start++) {
const window = rains.slice(start, start + 30);
const maxVal = Math.max(...window);
const minVal = Math.min(...window);
if (maxVal - minVal <= 0.5 && maxVal >= THRESHOLD) {
hasStable30min = true;
stableStart = start;
stableTime = new Date(minutes[start].time).toLocaleTimeString("zh-HK", { hour: "2-digit", minute: "2-digit" });
break;
}
}
if (hasStable30min) {
triggered2 = true;
msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸‰å°æ™‚å…§æœ‰é›¨`;
console.log("âœ… æ¢ä»¶2è§¸ç™¼ â†’ stableStart:", stableStart, " stableTime:", stableTime, " msg:", msg);
}
}

document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦");
</script>
</body>
</html>