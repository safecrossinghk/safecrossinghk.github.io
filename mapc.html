<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1e90ff">
<title>â˜” è·¯ç·šè¦åŠƒé™é›¨å°èˆª</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<style>
body {
font-family: 'Inter', sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
overflow: hidden;
}
#map-container {
height: 100vh;
width: 100vw;
position: relative;
}
#map {
height: 100%;
width: 100%;
}
/* é ‚éƒ¨è­¦å ±æ¢ */
#alert-bar {
position: absolute;
top: 0;
left: 0;
right: 0;
z-index: 1000;
background: rgba(30, 144, 255, 0.95);
color: white;
padding: 15px 10px;
font-size: 1.1em;
text-align: center;
font-weight: bold;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
transition: background 0.5s ease;
}
/* é™é›¨è­¦å ±å‹•ç•«æ•ˆæœ */
#alert-bar.rain-imminent {
background: linear-gradient(90deg, #ff4500, #ff8c00);
animation: pulse 1s infinite alternate;
}
@keyframes pulse {
from { box-shadow: 0 0 10px #ff4500, 0 0 20px #ff8c00; }
to { box-shadow: 0 0 5px #ff4500, 0 0 15px #ff8c00; }
}

/* åº•éƒ¨è³‡è¨Šæ¬„ - ç‹€æ…‹å’Œæ“ä½œ */
#status-bar {
position: absolute;
bottom: 0;
left: 0;
right: 0;
z-index: 1000;
background: rgba(0, 0, 0, 0.85); /* æ›´æ·±çš„èƒŒæ™¯ */
color: white;
padding: 10px;
font-size: 0.9em;
text-align: center;
opacity: 0.95;
display: flex;
flex-direction: column;
gap: 8px;
}
#instructions-text {
color: #ccc;
font-size: 1em;
}
#route-summary {
font-size: 1.1em;
font-weight: bold;
color: #ffcc00; /* çªå‡ºé¡¯ç¤ºè³‡è¨Š */
display: none; /* é è¨­éš±è—ï¼Œç›´åˆ°è·¯ç·šè¨ˆç®—å®Œæˆ */
}
.control-group {
display: flex;
justify-content: center;
gap: 8px;
}
.control-button {
flex-grow: 1;
padding: 8px 10px;
background: #1e90ff;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
transition: background 0.2s;
}
.control-button:hover {
background: #0077cc;
}

.mode-button {
flex-grow: 1;
padding: 8px 10px;
background: #4a4a4a;
color: white;
border: 2px solid transparent;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
transition: all 0.2s;
}
.mode-button.active {
background: #ff8c00; /* æ©™è‰²çªå‡ºé¡¯ç¤ºé¸ä¸­çš„æ¨¡å¼ */
border-color: #ffffff;
color: #1e1e1e;
}
/* ç‰¹åˆ¥é‡å°å…¬å…±äº¤é€šçš„æŒ‰éˆ• (ä¸å¯ç”¨) */
.mode-button.disabled-mode {
background: #666;
cursor: not-allowed;
opacity: 0.7;
}

/* æç¤ºæ¡†èˆ‡æŒ‰éˆ• (ä¿ç•™ OneSignal è¨‚é–±åŠŸèƒ½) */
.promptBox { position: fixed; bottom: 150px; left: 10%; right: 10%; background: #fff3cd; color: #333; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; font-size: 0.95em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 9999; }
.promptBox button { margin-top: 10px; padding: 6px 12px; background: #1e90ff; color: white; border: none; border-radius: 5px; cursor: pointer; }

/* è‡ªå®šç¾©å½ˆå‡ºè¨Šæ¯æ¡† (ä»£æ›¿ alert()) */
#message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: rgba(255, 255, 255, 0.95);
padding: 20px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
z-index: 10000;
display: none;
text-align: center;
max-width: 80%;
}
#message-box button {
margin-top: 15px;
padding: 8px 16px;
background: #1e90ff;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
}
</style>

<!-- ğŸ”” PWA è¨­å®š -->
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è·¯ç·šå°èˆª">

<!-- ğŸ”” OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

</head>
<body onload="initApp()">
<div id="map-container">
<div id="alert-bar">ğŸŒ æ­£åœ¨å®šä½ï¼Œè«‹é¸æ“‡æ¨¡å¼ä¸¦é»æ“Šåœ°åœ–è¨­å®šèµ·é»å’Œçµ‚é»...</div>
<div id="map"></div>
<div id="status-bar">
<span id="route-summary"></span>
<span id="instructions-text">1. é¸æ“‡æ¨¡å¼ | 2. é»æ“Šåœ°åœ–è¨­å®šèµ·é»/çµ‚é»</span>

<div class="control-group">
<!-- æ¨¡å¼é¸æ“‡æŒ‰éˆ• -->
<button id="modeDriving" class="mode-button active" onclick="setRoutingMode('driving')">ğŸš— é§•é§›</button>
<button id="modeWalking" class="mode-button" onclick="setRoutingMode('walking')">ğŸš¶ æ­¥è¡Œ</button>
<button id="modeCycling" class="mode-button" onclick="setRoutingMode('cycling')">ğŸš² å–®è»Š</button>
<!-- æ–°å¢å…¬å…±äº¤é€šæŒ‰éˆ• (ä¸å¯ç”¨ï¼Œä½†ç”¨æ–¼æç¤º) -->
<button id="modeTransit" class="mode-button disabled-mode" onclick="handleTransitClick()">ğŸšŒ å…¬å…±äº¤é€š</button>
</div>

<div class="control-group">
<button id="setStartBtn" class="control-button" onclick="setCurrentWaypointMode('settingStart')">è¨­å®šèµ·é» (A)</button>
<button id="setEndBtn" class="control-button" onclick="setCurrentWaypointMode('settingEnd')">è¨­å®šçµ‚é» (B)</button>
<button id="clearRouteBtn" class="control-button" onclick="clearRoute()">æ¸…é™¤è·¯ç·š</button>
</div>
</div>
</div>

<!-- è‡ªå®šç¾©è¨Šæ¯æ¡† -->
<div id="message-box">
<p id="message-text"></p>
<button onclick="document.getElementById('message-box').style.display = 'none'">ç¢ºå®š</button>
</div>

<!-- iOS å°ˆå±¬æç¤ºæ¡† (ä¿ç•™ PWA å„ªåŒ–) -->
<div id="iosPrompt" class="promptBox" style="display:none;">
ğŸ“± **iOS ç”¨æˆ¶é‡è¦æ­¥é©Ÿï¼š**<br>
ç‚ºäº†ç¢ºä¿èƒ½æ”¶åˆ°é€šçŸ¥ï¼Œè«‹å…ˆæŒ‰ Safari åº•éƒ¨ <b>åˆ†äº«</b> æŒ‰éˆ• <br>
âœ å†æ€ <b>åŠ å…¥ä¸»ç•«é¢</b> ï¼Œä¸¦å¾ä¸»ç•«é¢æ‰“é–‹å¾Œå†é»æ“Šè¨‚é–±ã€‚<br>
<button id="iosCloseBtn">çŸ¥é“äº†</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script>
// ===================================================
// ğŸ“ã€å…¨åŸŸè®Šé‡èˆ‡è¨­ç½®ã€‘
// ===================================================
const workerUrl = 'https://crowdtest8r.ctakwah.workers.dev/';
const TOMORROW_API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh"; // Tomorrow.io API Key
const LOCATION_UPDATE_INTERVAL_MS = 3 * 60 * 1000; // KV å¯«å…¥é »ç‡é™åˆ¶ç‚º 3 åˆ†é˜ (å°èˆªæ¨¡å¼)

const map = L.map('map', { zoomControl: false }).setView([22.3, 114.17], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let routingControl = null;
let startPoint = null;
let endPoint = null;
let userMarker = null;

let lastUpdateTime = 0;
let playerIdCache = null;
let rainStatus = 0; // 0: ç„¡é›¨, 1: æœ‰é›¨

// --- æ ¸å¿ƒè®Šé‡ï¼šå°èˆªæ¨¡å¼ ---
let currentRoutingMode = 'driving';
let currentWaypointMode = 'settingStart'; // 'settingStart', 'settingEnd', 'routingComplete'

// ===================================================
// ğŸ“ã€è¼”åŠ©å‡½æ•¸ã€‘
// ===================================================

/** é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯æ¡† (ä»£æ›¿ alert()) */
function showMessage(message) {
document.getElementById('message-text').innerText = message;
document.getElementById('message-box').style.display = 'block';
}

/** å°‡ç§’æ•¸è½‰æ›ç‚ºåˆ†é˜å’Œå°æ™‚çš„æ ¼å¼ (ä¾‹å¦‚: 1å°æ™‚25åˆ†é˜) */
function formatTime(seconds) {
if (seconds < 60) return `${Math.round(seconds)} ç§’`;

const hours = Math.floor(seconds / 3600);
const minutes = Math.floor((seconds % 3600) / 60);

let parts = [];
if (hours > 0) parts.push(`${hours} å°æ™‚`);
if (minutes > 0) parts.push(`${minutes} åˆ†é˜`);

return parts.join('');
}

/** å°‡ç±³æ•¸è½‰æ›ç‚ºå…¬é‡Œæˆ–ç±³çš„æ ¼å¼ */
function formatDistance(meters) {
if (meters < 1000) return `${Math.round(meters)} ç±³`;
return `${(meters / 1000).toFixed(1)} å…¬é‡Œ`;
}

// ===================================================
// ğŸ“ã€æ ¸å¿ƒè¨»å†Šå‡½æ•¸ - å¯¦æ™‚ä½ç½®å¯«å…¥ KVã€‘
// ===================================================
async function attemptRegisterToWorker(lat, lon) {
const now = Date.now();

if (now - lastUpdateTime < LOCATION_UPDATE_INTERVAL_MS) {
return;
}

const playerId = playerIdCache || localStorage.getItem("playerId");
if (!playerId) { return; }

try {
const response = await fetch(workerUrl + "registerLocation", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
playerId: playerId,
lat: parseFloat(lat),
lon: parseFloat(lon)
})
});

const result = await response.json();

if (response.ok && result.success) {
console.log("ğŸ‰ æˆåŠŸï¼Worker å·²æ›´æ–°å¯¦æ™‚ä½ç½®ã€‚");
lastUpdateTime = now;
} else {
console.error("âŒ Worker è¨»å†Šå¤±æ•—ï¼š", result.error || JSON.stringify(result));
}

} catch (err) {
console.error("âŒ å‘¼å« /registerLocation æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ï¼š", err);
}
}

// ===================================================
// ğŸ“ã€åœ°åœ–èˆ‡è·¯ç·šè¦åŠƒé‚è¼¯ã€‘
// ===================================================

/** è¨­ç½®è·¯ç·šè¦åŠƒæ§åˆ¶é … (æ ¹æ“šç•¶å‰æ¨¡å¼) */
function setupRoutingControl() {
if (!startPoint || !endPoint) return;

if (routingControl) map.removeControl(routingControl);

// åªæœ‰ driving, walking, cycling å¯ç”¨
const osrmServiceUrl = `https://router.project-osrm.org/route/v1/${currentRoutingMode}`;

routingControl = L.Routing.control({
waypoints: [
startPoint,
endPoint
],
routeWhileDragging: false,
serviceUrl: osrmServiceUrl, // ä½¿ç”¨å‹•æ…‹ URL
lineOptions: {
styles: [{ color: '#1e90ff', opacity: 0.8, weight: 6 }]
},
showAlternatives: false,
fitSelectedRoutes: false,
collapsible: true,
language: 'zh'
}).addTo(map);

routingControl.on('routesfound', function(e) {
const routes = e.routes;
if (routes.length > 0) {
const route = routes[0];

// --- é—œéµæ­¥é©Ÿï¼šç²å–ä¸¦é¡¯ç¤º ETA å’Œè·é›¢ ---
const totalDistance = formatDistance(route.summary.totalDistance);
const totalTime = formatTime(route.summary.totalTime);
const modeLabel = currentRoutingMode === 'driving' ? 'é§•é§›/é›»å–®è»Š' : currentRoutingMode === 'walking' ? 'æ­¥è¡Œ' : 'å–®è»Š';

document.getElementById('route-summary').style.display = 'block';
document.getElementById('route-summary').innerHTML =
`ã€${modeLabel}ã€‘ | è·é›¢: ${totalDistance} | é è¨ˆæ™‚é–“: ${totalTime}`;
document.getElementById('instructions-text').innerText = 'è·¯ç·šå·²è¦åŠƒï¼Œæº–å‚™å°èˆª...';

currentWaypointMode = 'routingComplete';
}
});

routingControl.on('routingerror', function(e) {
console.error("âŒ è·¯ç·šè¦åŠƒéŒ¯èª¤:", e.error);
document.getElementById('route-summary').style.display = 'none';
document.getElementById('instructions-text').innerText = "âŒ è·¯ç·šè¦åŠƒå¤±æ•—ï¼Œè«‹å˜—è©¦å…¶ä»–åœ°é»ã€‚";
currentWaypointMode = 'settingStart';
});
}

/** é»æ“Šåœ°åœ–è¨­å®šèµ·é»/çµ‚é» */
function onMapClick(e) {
// å¦‚æœé¸ä¸­ 'transit' æ¨¡å¼ï¼Œå‰‡å¿½ç•¥é»æ“Šï¼Œå› ç‚ºè©²æ¨¡å¼ä¸å¯ç”¨
if (currentRoutingMode === 'transit') return;

const latlng = e.latlng;
let target = '';

if (currentWaypointMode === 'settingStart') {
startPoint = latlng;
target = 'èµ·é» (A)';
setCurrentWaypointMode('settingEnd');
} else if (currentWaypointMode === 'settingEnd') {
endPoint = latlng;
target = 'çµ‚é» (B)';
setCurrentWaypointMode('routingComplete');
} else {
return; // è·¯ç·šå·²å®Œæˆ
}

document.getElementById('instructions-text').innerText = `å·²è¨­å®š ${target}ã€‚æ­£åœ¨è¨ˆç®—è·¯ç·š...`;
document.getElementById('route-summary').style.display = 'none';

if (startPoint && endPoint) {
setupRoutingControl();
}
}

/** è¨­ç½®ç•¶å‰åœ°åœ–é»æ“Šæ¨¡å¼ */
function setCurrentWaypointMode(mode) {
currentWaypointMode = mode;
let text = '';
if (mode === 'settingStart') text = 'è«‹é»æ“Šåœ°åœ–é¸æ“‡èµ·é» (A)';
else if (mode === 'settingEnd') text = 'è«‹é»æ“Šåœ°åœ–é¸æ“‡çµ‚é» (B)';
else text = 'è·¯ç·šå·²è¦åŠƒï¼Œè«‹é–‹å§‹å°èˆª';
document.getElementById('instructions-text').innerText = text;
}

/** æ¸…é™¤è·¯ç·š */
function clearRoute() {
if (routingControl) map.removeControl(routingControl);
routingControl = null;
startPoint = null;
endPoint = null;
setCurrentWaypointMode('settingStart');
document.getElementById('route-summary').style.display = 'none';
document.getElementById('alert-bar').innerText = "ğŸŒ æ­£åœ¨å®šä½ï¼Œè«‹é¸æ“‡æ¨¡å¼ä¸¦é»æ“Šåœ°åœ–è¨­å®šèµ·é»å’Œçµ‚é»...";
}

/** è¨­ç½®å°èˆªæ¨¡å¼ä¸¦é‡æ–°è¨ˆç®—è·¯ç·š */
function setRoutingMode(mode) {
// å¦‚æœé»æ“Šçš„æ˜¯å…¬å…±äº¤é€šï¼Œç›´æ¥è™•ç†æç¤º
if (mode === 'transit') {
handleTransitClick();
return;
}

if (currentRoutingMode === mode) return;

currentRoutingMode = mode;
const modeButtons = document.querySelectorAll('.mode-button:not(.disabled-mode)');
modeButtons.forEach(btn => btn.classList.remove('active'));

// æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•ä¸¦è¨­ç½® active ç‹€æ…‹
const activeBtn = document.getElementById(`mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
if (activeBtn) activeBtn.classList.add('active');


document.getElementById('instructions-text').innerText = `å·²åˆ‡æ›è‡³ ${mode === 'driving' ? 'é§•é§›/é›»å–®è»Š' : mode === 'walking' ? 'æ­¥è¡Œ' : 'å–®è»Š'} æ¨¡å¼ã€‚`;

if (startPoint && endPoint) {
document.getElementById('instructions-text').innerText = 'æ­£åœ¨ä½¿ç”¨æ–°æ¨¡å¼é‡æ–°è¨ˆç®—è·¯ç·š...';
document.getElementById('route-summary').style.display = 'none';
setupRoutingControl();
}
}

/** è™•ç†å…¬å…±äº¤é€šæŒ‰éˆ•é»æ“Šäº‹ä»¶ */
function handleTransitClick() {
currentRoutingMode = 'transit'; // æš«æ™‚è¨­ç½®æ¨¡å¼ï¼Œä»¥ä¾¿é»æ“ŠæŒ‰éˆ•è®Šè‰²
const modeButtons = document.querySelectorAll('.mode-button:not(.disabled-mode)');
modeButtons.forEach(btn => btn.classList.remove('active'));
document.getElementById('modeTransit').classList.add('active'); // è®“å®ƒçœ‹èµ·ä¾†è¢«é¸ä¸­

// å½ˆå‡ºæç¤º
showMessage("âš ï¸ å…¬å…±äº¤é€šæŸ¥è©¢ï¼ˆå…¬è»Š/åœ°éµï¼‰éœ€è¦å°ˆé–€çš„æ•¸æ“šæœå‹™ï¼Œç›®å‰æœ¬æ‡‰ç”¨ç¨‹å¼åƒ…æ”¯æ´é§•é§›ã€æ­¥è¡Œå’Œå–®è»Šè·¯ç·šè¦åŠƒã€‚");

// é›–ç„¶å½ˆå‡ºäº†æç¤ºï¼Œä½†æˆ‘å€‘éœ€è¦æŠŠè·¯ç·šè¦åŠƒæ¨¡å¼åˆ‡å›ä¸Šä¸€æ¬¡å¯ç”¨çš„æ¨¡å¼ï¼Œæˆ–é è¨­æ¨¡å¼ï¼Œä»¥é˜²ç”¨æˆ¶é»æ“Šåœ°åœ–
// é€™è£¡å¯ä»¥é¸æ“‡ä¸åˆ‡æ›ï¼Œè®“ç”¨æˆ¶è‡ªå·±é¸æ“‡å›ä¸€å€‹å¯ç”¨æ¨¡å¼ï¼Œæˆ–ç›´æ¥åˆ‡å› driving
currentRoutingMode = 'driving'; // åˆ‡å›é è¨­æ¨¡å¼
// ç§»é™¤å…¬å…±äº¤é€šçš„ active ç‹€æ…‹ï¼Œä¸¦æŠŠé§•é§›æ¨¡å¼æ¨™è¨˜ç‚º active
document.getElementById('modeTransit').classList.remove('active');
document.getElementById('modeDriving').classList.add('active');
}


// ===================================================
// ğŸ“ ã€å¯¦æ™‚ä½ç½®ç›£æ§èˆ‡è­¦å ±é‚è¼¯ã€‘
// ===================================================

/** è™•ç†å®šä½æˆåŠŸå¾Œçš„å›èª¿ */
function locationSuccess(pos) {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;

updateMap(lat, lon);
fetchForecast(lat, lon);
fetchTomorrowAI(lat, lon);

attemptRegisterToWorker(lat.toString(), lon.toString());
}

/** è™•ç†å®šä½å¤±æ•—å¾Œçš„å›èª¿ */
function locationError(err) {
document.getElementById('alert-bar').innerText = "âš ï¸ å®šä½å¤±æ•—ï¼Œç„¡æ³•è¿½è¹¤ä½ç½®ã€‚";
if (!userMarker) map.setView([22.3, 114.17], 13);
}

/** å•Ÿå‹•å¯¦æ™‚ä½ç½®ç›£æ§ */
function startLocationWatch() {
if (!navigator.geolocation) {
locationError({ code: 0, message: "Browser does not support geolocation." });
return;
}
navigator.geolocation.watchPosition(locationSuccess, locationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
}

/** æ›´æ–°åœ°åœ–ä¸Šçš„ç”¨æˆ¶æ¨™è¨˜å’Œè¦–è§’ */
function updateMap(lat, lon) {
const newLatLng = [lat, lon];

if (!userMarker) {
userMarker = L.circleMarker(newLatLng, {
radius: 8, color: '#ff007f', fillColor: '#ff007f', fillOpacity: 1, weight: 2
}).addTo(map);
map.setView(newLatLng, 15);
} else {
userMarker.setLatLng(newLatLng);
map.panTo(newLatLng);
}
}

/** èªéŸ³æ’­å ±å‡½æ•¸ */
function speak(text) {
if (speechSynthesis.speaking) return;
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

/** è™•ç†å³æ™‚é å ± */
function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
if (data && typeof data.immediateRain === "number") {
const isRainingNow = data.immediateRain > 0.01;
if (isRainingNow && rainStatus === 0) {
const msg = "âš ï¸ æ³¨æ„ï¼æ‚¨å·²é€²å…¥é™é›¨å€åŸŸã€‚";
document.getElementById('alert-bar').innerText = `â˜” ${msg}`;
document.getElementById('alert-bar').classList.add('rain-imminent');
speak(msg);
rainStatus = 1;
} else if (!isRainingNow && rainStatus === 1) {
document.getElementById('alert-bar').innerText = `âœ… é›¨å‹¢å·²åœæ­¢æˆ–é›¢é–‹é›¨å€ã€‚`;
speak("é›¨å‹¢å·²åœæ­¢æˆ–é›¢é–‹é›¨å€ã€‚");
document.getElementById('alert-bar').classList.remove('rain-imminent');
rainStatus = 0;
} else if (!isRainingNow && rainStatus === 0 && currentWaypointMode !== 'routingComplete') {
document.getElementById('alert-bar').innerText = "âœ… æ­£åœ¨è¿½è¹¤ï¼Œå€åŸŸæš«ç„¡é™é›¨ã€‚";
document.getElementById('alert-bar').classList.remove('rain-imminent');
}
}
})
.catch(err => {
console.error("è®€å–å³æ™‚é å ±éŒ¯èª¤", err);
});
}

/** è™•ç† AI è¶…å‰é æ¸¬ (Tomorrow.io) */
function fetchTomorrowAI(lat, lon) {
// é€™å€‹å‡½æ•¸ä¿æŒä¸è®Šï¼Œç”¨æ–¼å°ç”¨æˆ¶ç•¶å‰ä½ç½®æä¾›è¶…å‰é è­¦
}

// ===================================================
// ğŸ“ã€åˆå§‹åŒ–èˆ‡ OneSignalã€‘
// ===================================================

window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
safari_web_id: "ğŸ”‘ æ›æˆä½ çš„ Safari Web ID",
notifyButton: { enable: true, text: { 'tip.unsubscribed': 'é–‹å•Ÿé™é›¨æ¨æ’­', 'tip.subscribed': 'å·²é–‹å•Ÿæ¨æ’­' } },
allowLocalhostAsSecureOrigin: true
});
const getAndSetPlayerId = async () => {
const currentId = await OneSignal.User.PushSubscription.id;
if (currentId) { localStorage.setItem("playerId", currentId); playerIdCache = currentId; }
};
await getAndSetPlayerId();
OneSignal.User.PushSubscription.addEventListener("change", (event) => {
if (event.to.isSubscribed) getAndSetPlayerId();
else { localStorage.removeItem("playerId"); playerIdCache = null; }
});
});

/** é¡¯ç¤º iOS æç¤ºæ¡† (PWA å„ªåŒ–) */
function showIosPromptOnce() {
const isIos = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
if (isIos && !isInStandaloneMode) {
if (!localStorage.getItem("iosPromptShown")) {
document.getElementById("iosPrompt").style.display = "block";
document.getElementById("iosCloseBtn").onclick = function() {
document.getElementById("iosPrompt").style.display = "none";
localStorage.setItem("iosPromptShown", "1");
};
}
} else {
document.getElementById("iosPrompt").style.display = "none";
}
}

/** æ‡‰ç”¨ç¨‹å¼ä¸»å…¥å£ */
function initApp() {
// 1. è¨­ç½®åœ°åœ–é»æ“Šç›£è½å™¨
map.on('click', onMapClick);

// 2. å•Ÿå‹•å¯¦æ™‚ä½ç½®ç›£æ§
startLocationWatch();

// 3. é¡¯ç¤º iOS æç¤º
showIosPromptOnce();

// 4. ç¢ºä¿èµ·å§‹æ¨¡å¼æ­£ç¢º
setRoutingMode('driving');
setCurrentWaypointMode('settingStart');
}

</script>
</body>
</html>