<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>ğŸŒ§ï¸ é™é›¨æ¨æ’­æ¸¬è©¦ (Worker + OneSignal v6 Debug)</title>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.ok { color: green; }
.fail { color: red; }
textarea { width: 100%; height: 150px; margin-top: 10px; }
</style>
</head>
<body>
<h2>ğŸŒ§ï¸ é™é›¨æ¨æ’­æ¸¬è©¦ (Worker + OneSignal v6 Debug)</h2>

<div id="status">OneSignal è¨‚é–±ç‹€æ…‹ï¼šæª¢æŸ¥ä¸­...</div>
<div id="playerIdBox">player_id (UserId)ï¼š<span id="player_id">å°šæœªå–å¾—</span></div>

<button onclick="sendTestNotification()">ğŸ“© ç™¼é€æ¸¬è©¦æ¨æ’­</button>
<br><br>

<h3>Debug è¼¸å‡ºï¼š</h3>
<textarea id="debugLog"></textarea>

<script>
// åˆå§‹åŒ– OneSignal v6
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
try {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
safari_web_id: "ğŸ”´å¦‚æœæœ‰å°±å¡«ğŸ”´"
});

const id = await OneSignal.User.PushSubscription.id;
if (id) {
document.getElementById("status").innerHTML = "âœ… å·²è¨‚é–±æ¨æ’­";
document.getElementById("player_id").textContent = id;
log("æˆåŠŸå–å¾— player_id: " + id);
} else {
document.getElementById("status").innerHTML = "âŒ å°šæœªè¨‚é–±æ¨æ’­";
log("æœªèƒ½å–å¾— player_id");
}
} catch (e) {
log("åˆå§‹åŒ–éŒ¯èª¤: " + e);
}
});

// Debug log function
function log(msg) {
const box = document.getElementById("debugLog");
box.value += new Date().toLocaleTimeString() + " " + msg + "\n";
box.scrollTop = box.scrollHeight;
}

// æ¸¬è©¦æ¨æ’­ (ç›´æ¥å‘¼å« OneSignal API)
async function sendTestNotification() {
const playerId = document.getElementById("player_id").textContent;
if (!playerId || playerId === "å°šæœªå–å¾—") {
log("âŒ ç„¡æ³•ç™¼é€ï¼Œå› ç‚ºæœªå–å¾— player_id");
return;
}

log("æº–å‚™ç™¼é€æ¸¬è©¦æ¨æ’­è‡³ player_id: " + playerId);

try {
const response = await fetch("https://onesignal.com/api/v1/notifications", {
method: "POST",
headers: {
"Content-Type": "application/json; charset=utf-8",
"Authorization": "Basic os_v2_app_rabedtomivecbnpmuerwwdr6tciiske3mk5ez3mancrg7qmdy275ruzqq3c623gckamggtnnaqow5hyvghfdfbhhcbq2llehcl6jwki"
},
body: JSON.stringify({
app_id: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
include_player_ids: [playerId],
contents: { "en": "é€™æ˜¯ä¸€å€‹æ¸¬è©¦æ¨æ’­ âœ…" }
})
});

const result = await response.json();
log("API å›æ‡‰: " + JSON.stringify(result, null, 2));
} catch (e) {
log("æ¨æ’­ç™¼é€éŒ¯èª¤: " + e);
}
}
</script>
</body>
</html>