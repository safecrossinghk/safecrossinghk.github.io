<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OneSignal æ¨æ’­æ¸¬è©¦</title>

<!-- å®˜æ–¹ OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.js" async></script>

</head>
<body>
<h1>OneSignal Player ID æ¸¬è©¦</h1>
<p id="status">åˆå§‹åŒ–ä¸­...</p>
<button id="testPushBtn">ç™¼é€æ¸¬è©¦æ¨æ’­</button>

<script>
// ===========================
// 1ï¸âƒ£ è§£é™¤èˆŠ SW
// ===========================
if ('serviceWorker' in navigator) {
navigator.serviceWorker.getRegistrations()
.then(registrations => {
for (let reg of registrations) {
console.log('ğŸ—‘ï¸ ç§»é™¤èˆŠ SW:', reg.scope);
reg.unregister();
}
});
// æ¸…é™¤å¿«å–
caches.keys().then(keys => keys.forEach(key => caches.delete(key)));
}

// ===========================
// 2ï¸âƒ£ åˆå§‹åŒ–å®˜æ–¹ OneSignal SDK
// ===========================
window.OneSignal = window.OneSignal || [];
OneSignal.push(async () => {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98", // ä½ çš„ APP ID
safari_web_id: "web.onesignal.auto.c8a9d5f2-xxxxx-xxxxx", // çœŸå¯¦ Safari Web ID
notifyButton: { enable: true },
allowLocalhostAsSecureOrigin: true
});

// å–å¾— Player ID
const playerId = await OneSignal.getUserId();
if (playerId) {
localStorage.setItem("playerId", playerId);
document.getElementById("status").innerText = "âœ… Player ID å·²å–å¾—: " + playerId;
console.log("âœ… Player ID:", playerId);
} else {
document.getElementById("status").innerText = "âŒ å°šæœªå–å¾— Player IDï¼Œè«‹å…è¨±é€šçŸ¥";
console.warn("âŒ Player ID ç‚º nullï¼Œä½¿ç”¨è€…å¯èƒ½æœªå…è¨±é€šçŸ¥");
}
});

// ===========================
// 3ï¸âƒ£ æ¸¬è©¦æ¨æ’­æŒ‰éˆ•
// ===========================
document.getElementById("testPushBtn").onclick = async () => {
const playerId = localStorage.getItem("playerId");
if (!playerId) {
alert("âŒ å°šæœªå–å¾— Player IDï¼Œç„¡æ³•ç™¼é€æ¨æ’­");
return;
}

// ä½¿ç”¨ä½ çš„ Worker / å¾Œç«¯ API ç™¼é€æ¨æ’­
fetch("https://crowdtest8r.ctakwah.workers.dev/sendPush", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
playerId: playerId,
title: "ğŸŒ§ æ¸¬è©¦æ¨æ’­",
message: "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦è¨Šæ¯",
url: location.href
})
})
.then(res => res.json())
.then(data => console.log("æ¨æ’­å›å‚³:", data))
.catch(err => console.error("æ¨æ’­éŒ¯èª¤:", err));
};
</script>

</body>
</html>