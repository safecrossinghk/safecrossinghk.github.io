<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¦™æ¸¯å³æ™‚å¤©æ°£é›·é”+è‡¨è¿‘é å ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
font-family: 'Noto Sans HK', sans-serif;
background-color: #1a202c; /* æ·±ç°è—èƒŒæ™¯ */
color: #e2e8f0; /* æ·ºç°è‰²æ–‡å­— */
}
.map-container {
position: relative;
width: 100%;
max-width: 512px; /* é›·é”åœ–çš„å¯¬åº¦æ˜¯ 512px */
aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹ */
margin: 0 auto;
border: 2px solid #4a5568;
border-radius: 0.75rem;
overflow: hidden;
background-color: #2d3748;
}
.map-layer {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
user-select: none;
pointer-events: none;
}
.loader {
border: 4px solid #f3f3f3;
border-top: 4px solid #3498db;
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
position: absolute;
top: 50%;
left: 50%;
margin-top: -20px;
margin-left: -20px;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
.control-panel {
background-color: #2d3748;
border-radius: 0.75rem;
padding: 1.5rem;
margin-top: 1rem;
border: 1px solid #4a5568;
}
</style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-xl mx-auto">
<header class="text-center mb-6">
<h1 class="text-3xl font-bold text-white">é¦™æ¸¯å³æ™‚å¤©æ°£é›·é”</h1>
<p class="text-gray-400">é›·é”åœ– + è‡¨è¿‘é™é›¨é å ± + èªéŸ³è­¦å‘Š</p>
</header>

<main>
<!-- åœ°åœ–å®¹å™¨ -->
<div id="map-container" class="map-container shadow-lg">
<div id="loader" class="loader"></div>
<!-- åº•å±¤ï¼šå¤©æ°£é›·é”åœ– -->
<img id="radar-img" src="" alt="å¤©æ°£é›·é”åœ–" class="map-layer">
<!-- ä¸Šå±¤ï¼šè‡¨è¿‘é™é›¨é å ±åœ– -->
<img id="nowcast-img" src="" alt="è‡¨è¿‘é™é›¨é å ±åœ–" class="map-layer">
</div>

<!-- æ§åˆ¶é¢æ¿ -->
<div class="control-panel mt-6 shadow-lg">
<div class="space-y-4">
<!-- é å ±åœ–é€æ˜åº¦æ§åˆ¶ -->
<div>
<label for="opacity-slider" class="block mb-2 text-sm font-medium text-gray-300">é å ±åœ–é€æ˜åº¦</label>
<div class="flex items-center space-x-4">
<span class="text-sm">æ¸…æ™°</span>
<input id="opacity-slider" type="range" min="0" max="1" value="0.5" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
<span class="text-sm">é€æ˜</span>
</div>
</div>

<!-- èªéŸ³æç¤ºæ§åˆ¶ -->
<div>
<label class="block mb-2 text-sm font-medium text-gray-300">èªéŸ³æç¤º</label>
<div class="flex items-center space-x-4">
<button id="mute-toggle" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">
<span>ğŸ”Š é–‹å•Ÿ</span>
</button>
<button id="test-speech" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-colors">
æ¸¬è©¦èªéŸ³
</button>
</div>
</div>

<!-- ç‹€æ…‹é¡¯ç¤º -->
<div class="pt-4 border-t border-gray-600 text-sm text-gray-400 space-y-2">
<p>åœ–åƒæ›´æ–°æ™‚é–“: <span id="last-updated" class="font-medium text-gray-200">æ­£åœ¨è¼‰å…¥...</span></p>
<p>å¤©æ°£è­¦å‘Š: <span id="warning-status" class="font-medium text-gray-200">æ­£åœ¨æª¢æŸ¥...</span></p>
</div>
</div>
</div>

<footer class="text-center mt-8 text-xs text-gray-500">
<p>è³‡æ–™ä¾†æºï¼šé¦™æ¸¯å¤©æ–‡å°ã€‚æœ¬é é¢åƒ…ä¾›æŠ€è¡“æ¸¬è©¦åŠå€‹äººåƒè€ƒã€‚</p>
</footer>
</main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
// DOM å…ƒç´ 
const radarImg = document.getElementById('radar-img');
const nowcastImg = document.getElementById('nowcast-img');
const opacitySlider = document.getElementById('opacity-slider');
const lastUpdatedSpan = document.getElementById('last-updated');
const warningStatusSpan = document.getElementById('warning-status');
const muteToggleBtn = document.getElementById('mute-toggle');
const testSpeechBtn = document.getElementById('test-speech');
const loader = document.getElementById('loader');

// ç‹€æ…‹è®Šæ•¸
let isMuted = false;
let lastWarnings = {};
let imagesLoaded = { radar: false, nowcast: false };

// --- èªéŸ³åˆæˆåŠŸèƒ½ ---
function speak(text) {
if (isMuted || !window.speechSynthesis) return;

// å–æ¶ˆä¹‹å‰å¯èƒ½åœ¨éšŠåˆ—ä¸­çš„èªéŸ³
window.speechSynthesis.cancel();

const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'zh-HK'; // æŒ‡å®šç²µèªï¼ˆé¦™æ¸¯ï¼‰
utterance.rate = 1.0;
utterance.pitch = 1.0;
window.speechSynthesis.speak(utterance);
}

// --- åœ–åƒæ›´æ–°åŠŸèƒ½ ---
function updateImages() {
console.log('æ­£åœ¨æ›´æ–°åœ–åƒ...');
const timestamp = new Date().getTime(); // é˜²æ­¢å¿«å–

// ä½¿ç”¨ CORS ä»£ç†ä¾†è§£æ±ºè·¨åŸŸè¼‰å…¥éŒ¯èª¤
const proxy = 'https://corsproxy.io/?';
const radarUrl = `${proxy}https://www.hko.gov.hk/wxinfo/radars/radar256/latest_rad256.jpg?t=${timestamp}`;
const nowcastUrl = `${proxy}https://www.hko.gov.hk/wxinfo/nowcast/radar_range1/swir_256_dly.gif?t=${timestamp}`;

// ä½¿ç”¨é è¼‰å…¥æŠ€è¡“é˜²æ­¢é–ƒçˆ
preloadImage(radarUrl, radarImg, 'radar');
preloadImage(nowcastUrl, nowcastImg, 'nowcast');

lastUpdatedSpan.textContent = new Date().toLocaleTimeString('zh-HK');
}

function preloadImage(url, imgElement, type) {
const tempImg = new Image();
tempImg.src = url;
tempImg.onload = () => {
imgElement.src = url;
imagesLoaded[type] = true;
// ç•¶å…©å¼µåœ–ç‰‡éƒ½è¼‰å…¥å®Œæˆå¾Œï¼Œéš±è—è¼‰å…¥å‹•ç•«
if (imagesLoaded.radar && imagesLoaded.nowcast) {
loader.style.display = 'none';
}
};
tempImg.onerror = () => {
console.error(`ç„¡æ³•è¼‰å…¥åœ–åƒ: ${url}`);
}
}

// --- å¤©æ°£è­¦å‘Šæª¢æŸ¥ ---
async function checkWeatherWarnings() {
console.log('æ­£åœ¨æª¢æŸ¥å¤©æ°£è­¦å‘Š...');
try {
// ä½¿ç”¨ CORS ä»£ç†ä¾†è§£æ±ºè·¨åŸŸè¼‰å…¥éŒ¯èª¤
const proxy = 'https://corsproxy.io/?';
const warningUrl = `${proxy}https://data.weather.gov.hk/weather-data/json/WeatherWarningSummary.json?t=${new Date().getTime()}`;
const response = await fetch(warningUrl);
if (!response.ok) {
throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
}
const data = await response.json();

let activeWarnings = [];
let newWarnings = [];

// éæ­·æ‰€æœ‰å¯èƒ½çš„è­¦å‘Šé¡å‹
for (const key in data) {
if (data.hasOwnProperty(key) && data[key].actionCode && data[key].actionCode !== 'CANCEL') {
const warningName = data[key].name;
activeWarnings.push(warningName);
// æª¢æŸ¥é€™æ˜¯ä¸æ˜¯ä¸€å€‹æ–°çš„è­¦å‘Š
if (!lastWarnings[warningName]) {
newWarnings.push(warningName);
}
}
}

if (activeWarnings.length === 0) {
warningStatusSpan.textContent = 'æ²’æœ‰ç”Ÿæ•ˆçš„è­¦å‘Šã€‚';
warningStatusSpan.style.color = '#a0aec0'; // Gray
} else {
warningStatusSpan.textContent = activeWarnings.join('ã€');
warningStatusSpan.style.color = '#f56565'; // Red
}

// å¦‚æœæœ‰æ–°çš„è­¦å‘Šï¼Œå‰‡è§¸ç™¼èªéŸ³æç¤º
if (newWarnings.length > 0) {
const speechText = `å¤©æ°£å ±å‘Šï¼šå¤©æ–‡å°ç™¼å‡º ${newWarnings.join('ã€')}ã€‚`;
console.log('åµæ¸¬åˆ°æ–°è­¦å‘Š:', speechText);
speak(speechText);
}

// æ›´æ–°æœ€å¾Œçš„è­¦å‘Šç‹€æ…‹
lastWarnings = {};
activeWarnings.forEach(name => {
lastWarnings[name] = true;
});

} catch (error) {
console.error('ç„¡æ³•ç²å–å¤©æ°£è­¦å‘Š:', error);
warningStatusSpan.textContent = 'æª¢æŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
}
}

// --- äº‹ä»¶ç›£è½å™¨ ---
opacitySlider.addEventListener('input', (e) => {
nowcastImg.style.opacity = e.target.value;
});

muteToggleBtn.addEventListener('click', () => {
isMuted = !isMuted;
muteToggleBtn.innerHTML = isMuted ? '<span>ğŸ”‡ éœéŸ³</span>' : '<span>ğŸ”Š é–‹å•Ÿ</span>';
muteToggleBtn.classList.toggle('bg-red-600', isMuted);
muteToggleBtn.classList.toggle('hover:bg-red-700', isMuted);
muteToggleBtn.classList.toggle('bg-blue-600', !isMuted);
muteToggleBtn.classList.toggle('hover:bg-blue-700', !isMuted);

if (!isMuted) {
speak('èªéŸ³æç¤ºå·²é–‹å•Ÿ');
} else {
window.speechSynthesis.cancel(); // å¦‚æœæ­£åœ¨èªªè©±ï¼Œç«‹å³åœæ­¢
}
});

testSpeechBtn.addEventListener('click', () => {
speak('é€™æ˜¯ä¸€å€‹èªéŸ³æ¸¬è©¦ã€‚');
});

// --- åˆå§‹åŒ–å’Œå®šæ™‚ä»»å‹™ ---
function initialize() {
// åˆå§‹åŒ–é€æ˜åº¦
nowcastImg.style.opacity = opacitySlider.value;

// ç«‹å³åŸ·è¡Œä¸€æ¬¡ä»¥ç²å–åˆå§‹è³‡æ–™
updateImages();
checkWeatherWarnings();

// è¨­å®šå®šæ™‚æ›´æ–°ï¼ˆå¤©æ–‡å°é›·é”åœ–å¤§ç´„6åˆ†é˜æ›´æ–°ä¸€æ¬¡ï¼‰
setInterval(updateImages, 6 * 60 * 1000);
// å®šæ™‚æª¢æŸ¥å¤©æ°£è­¦å‘Šï¼ˆæ¯åˆ†é˜ï¼‰
setInterval(checkWeatherWarnings, 60 * 1000);
}

initialize();
});
</script>
</body>
</html>