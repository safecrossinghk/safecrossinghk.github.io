<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>即時雨量 + 預報 (手機版)</title>
<style>
body {
font-family: "PingFang HK", "Microsoft JhengHei", sans-serif;
margin: 0;
padding: 0;
background: #f0f2f5;
color: #333;
}
header {
background: #0078d7;
color: white;
padding: 1rem;
text-align: center;
font-size: 1.2rem;
}
.container {
padding: 1rem;
display: flex;
flex-direction: column;
gap: 1rem;
}
button {
padding: 1rem;
font-size: 1.1rem;
border: none;
border-radius: 8px;
background: #0078d7;
color: white;
cursor: pointer;
}
button:active {
background: #005a9e;
}
.toggle-btn {
background: #6c757d;
}
.toggle-btn.active {
background: #28a745;
}
.card {
background: white;
padding: 1rem;
border-radius: 8px;
box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.rain {
font-size: 1.1rem;
font-weight: bold;
padding: 0.5rem;
border-radius: 5px;
margin-top: 0.5rem;
}
.no-rain { background: #c8f7c5; color: #2c662d; }
.light-rain { background: #fff3cd; color: #856404; }
.heavy-rain { background: #f8d7da; color: #721c24; }
.future {
display: flex;
justify-content: space-between;
margin-top: 0.5rem;
}
.future div {
flex: 1;
margin: 0 3px;
padding: 0.5rem;
text-align: center;
border-radius: 5px;
font-size: 0.9rem;
}
</style>
</head>
<body>
<header>🌧 即時雨量 + 未來預報</header>
<div class="container">
<button onclick="getRainfall()">📍 查詢我附近雨量</button>
<button id="voiceToggle" class="toggle-btn active" onclick="toggleVoice()">🔊 語音提示：開</button>
<div id="result" class="card">請按上面按鈕開始查詢</div>
</div>

<script>
let voiceEnabled = true; // 預設開啟語音

async function getRainfall() {
if (!navigator.geolocation) {
document.getElementById("result").innerText = "❌ 瀏覽器不支援定位";
return;
}

navigator.geolocation.getCurrentPosition(async pos => {
const lat = pos.coords.latitude.toFixed(3);
const lon = pos.coords.longitude.toFixed(3);

const url = `https://enquiry.ctakwah.workers.dev?lat=${lat}&lon=${lon}`;

document.getElementById("result").innerHTML = "⏳ 正在查詢雨量資料...";

try {
const res = await fetch(url);
const data = await res.json();
renderRainResult(data);
} catch (e) {
document.getElementById("result").innerText = "⚠️ 無法讀取數據";
}
}, err => {
document.getElementById("result").innerText = "❌ 無法取得定位: " + err.message;
});
}

function renderRainResult(data) {
if (data.error) {
document.getElementById("result").innerText = "⚠️ 錯誤: " + data.error;
return;
}

let rainClass = "no-rain";
let voiceMessage = data.message;
if (data.immediateRain >= 10) {
rainClass = "heavy-rain";
voiceMessage = "⚠️ 未來會有大雨，請小心。";
} else if (data.immediateRain >= 2.5) {
rainClass = "light-rain";
voiceMessage = "⚠️ 未來有雨，請準備雨具。";
} else {
voiceMessage = "☁️ 暫時未見明顯降雨。";
}

document.getElementById("result").innerHTML = `
<div><b>📍 位置：</b> (${data.location.lat}, ${data.location.lon})</div>
<div class="rain ${rainClass}">即時雨量：${data.immediateRain} mm<br>${data.message}</div>
<div class="future">
<div style="background:#e7f1ff">30 分鐘<br>${data.futureRains["30-60min"]} mm</div>
<div style="background:#e7f1ff">60 分鐘<br>${data.futureRains["60-90min"]} mm</div>
<div style="background:#e7f1ff">90 分鐘<br>${data.futureRains["90-120min"]} mm</div>
</div>
`;

// ✅ 語音播報（可關閉）
if (voiceEnabled) {
speak(voiceMessage);
}
}

function speak(text) {
if ('speechSynthesis' in window) {
const utter = new SpeechSynthesisUtterance(text);
utter.lang = "zh-HK"; // 粵語
speechSynthesis.cancel(); // 避免重疊
speechSynthesis.speak(utter);
}
}

function toggleVoice() {
voiceEnabled = !voiceEnabled;
const btn = document.getElementById("voiceToggle");
if (voiceEnabled) {
btn.classList.add("active");
btn.innerText = "🔊 語音提示：開";
} else {
btn.classList.remove("active");
btn.innerText = "🔇 語音提示：關";
}
}
</script>
</body>
</html>