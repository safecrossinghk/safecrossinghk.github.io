<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#f0f8ff">
<title>ğŸŒ§ï¸ é¦™æ¸¯é™é›¨é å ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
font-family: "Helvetica Neue", sans-serif;
margin: 0;
padding: 0;
background: #f0f8ff;
color: #333;
text-align: center;
}
h1 {
font-size: 1.4em;
margin: 1em 0 0.5em;
}
#map {
height: 300px;
margin: 0 10px;
border-radius: 8px;
border: 1px solid #ccc;
}
#ai-forecast {
margin: 1em;
padding: 1em;
border: 2px solid #0077cc;
border-radius: 8px;
background: #fff;
text-align: left;
}
#rain-alert {
margin: 1em;
font-size: 1.2em;
font-weight: bold;
line-height: 1.8em;
white-space: pre-line;
}
#footer-text {
margin: 1.5em;
font-size: 0.9em;
color: #555;
line-height: 1.6em;
}
.promptBox {
position: fixed;
bottom: 20px;
left: 10%;
right: 10%;
background: #fff3cd;
color: #333;
border: 1px solid #ffeeba;
padding: 15px;
border-radius: 10px;
font-size: 0.95em;
box-shadow: 0 2px 6px rgba(0,0,0,0.2);
z-index: 9999;
}
.promptBox button {
margin-top: 10px;
padding: 6px 12px;
background: #0077cc;
color: white;
border: none;
border-radius: 5px;
}
</style>

<!-- ğŸ”” PWA è¨­å®š -->
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="no">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="é¦™æ¸¯é™é›¨é å ±">

<!-- ğŸ”” OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
serviceWorkerPath: "/OneSignalSDKWorker.js" // âœ… æ ¹ç›®éŒ„
});
});
</script>
</head>

<body>
<h1>ğŸŒ‚ é¦™æ¸¯é™é›¨é å ±</h1>
<div id="map"></div>

<!-- AI è¶…å‰é æ¸¬ -->
<div id="ai-forecast">
<strong>ğŸ§  AI è¶…å‰é æ¸¬</strong>
<div id="rainMsg">â³ æ­£åœ¨è¼‰å…¥...</div>
</div>

<div id="rain-alert">â³ æ­£åœ¨è®€å–é å ±è³‡æ–™...</div>

<!-- å…¨è£ç½®å…±ç”¨æç¤ºæ¡† -->
<div id="customPrompt" class="promptBox" style="display:none;">
ğŸ“¢ æ­¡è¿ä½¿ç”¨ã€Šé¦™æ¸¯é™é›¨é å ±ã€‹<br>
ğŸ‘‰ ä½ å¯ä»¥è¨‚é–±é€šçŸ¥ï¼Œå³æ™‚æ”¶åˆ°é™é›¨æç¤ºã€‚<br>
<button id="subscribeBtn">è¨‚é–±é€šçŸ¥</button>
<button id="closeCustomBtn">ç¨å¾Œå†èªª</button>
</div>

<!-- iOS å°ˆå±¬æç¤ºæ¡† -->
<div id="iosPrompt" class="promptBox" style="display:none;">
ğŸ“± å¦‚æœä½ ç”¨ iPhone / iPadï¼š<br>
è«‹å…ˆæŒ‰ Safari åº•éƒ¨çš„ <b>åˆ†äº«</b> æŒ‰éˆ• <br>
âœ å†æ€ <b>åŠ å…¥ä¸»ç•«é¢</b> æ‰å¯æ”¶åˆ°æ¨æ’­é€šçŸ¥ã€‚<br>
<button id="iosCloseBtn">çŸ¥é“äº†</button>
</div>

<!-- æ–‡æœ«ä¸‰å¥ -->
<div id="footer-text">
<p style="text-align: left; margin-bottom: 1.5em;">
æœ¬ç¶²ç«™æä¾›é¦™æ¸¯æœªä¾†æœ€å¤šä¸‰å°æ™‚å…§å®šé»çš„é™é›¨é æ¸¬ï¼Œç”¨æˆ¶å¯å³æ™‚å¾—çŸ¥èº«è™•åœ°é»çš„é™é›¨æƒ…æ³ã€‚
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
è³‡æ–™ä¾†æºï¼šé¦™æ¸¯å¤©æ–‡å° / Tomorrow.io (AI è¶…å‰é æ¸¬)
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
- ç”¨æˆ¶è«‹å…ˆå…è¨±å®šä½æœå‹™
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
- é å ±åœ¨æŸäº›æƒ…æ³å¯èƒ½æœƒå‡ºç¾èª¤å·®
</p>
<p style="text-align: left; margin-bottom: 1.5em;">
ç¶²ç«™åŠŸèƒ½å°‡ä¸æ–·æ›´æ–°ï¼Œæ•¬è«‹ç•™æ„
</p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest8r.ctakwah.workers.dev/';
const TOMORROW_API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker;
let rainStatus = 0;

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

// ğŸŸ¢ OneSignal è‡ªå‹•æ¨æ’­å°è£
function sendPush(title, message) {
if (window.OneSignal) {
OneSignalDeferred.push(async function(OneSignal) {
await OneSignal.sendSelfNotification({
title: title,
message: message,
icon: "https://safecrossinghk.github.io/icon-192.png",
url: "https://safecrossinghk.github.io/index2a.html"
});
console.log("âœ… OneSignal æœ¬åœ°æ¨æ’­å·²è§¸ç™¼");
});
}
}

// ğŸŸ¡ å¤©æ–‡å°å³æ™‚é å ±
function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
console.log("API å›å‚³è³‡æ–™ï¼š", data);

if (data && typeof data.immediateRain === "number") {
if (data.immediateRain > 0.01) {
alertDiv.innerText = `âš ï¸ å³æ™‚é å ±ï¼šä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨`;
if (rainStatus === 0) {
speak("âš ï¸ ä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨");
sendPush("âš ï¸ é™é›¨æç¤º", "ä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨");
rainStatus = 1;
}
} else {
alertDiv.innerText = `â˜ï¸ ä½ æ‰€åœ¨çš„ä½ç½®æš«æ™‚ç„¡é›¨`;
rainStatus = 0;
}
} else {
alertDiv.innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
}
})
.catch(err => {
console.error("è®€å–é å ±éŒ¯èª¤", err);
document.getElementById('rain-alert').innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
});
}

// ğŸ”µ Tomorrow.io AI é å ±
function fetchTomorrowAI(lat, lon) {
fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${lat},${lon}&timesteps=1m&endTime=+180m&apikey=${TOMORROW_API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180);
const rains = minutes.map(m => m.values.rainIntensity);

let msg = "ç•¶é™é›¨å‰ä¸€è‡³ä¸‰å°æ™‚å…§æœƒæä¾›ç›¸é—œè¨Šæ¯";
let triggered1 = false;
let triggered2 = false;

const rains1to3h = rains.slice(60, 180);
const overThreshold1to3h = rains1to3h.some(r => r >= 1.0);

let hasRising = false;
let risingMinute = -1;
for (let i = 61; i < 180; i++) {
if (rains[i] > rains[i - 1] && rains[i] >= 1.0) {
hasRising = true;
risingMinute = i;
break;
}
}

if (overThreshold1to3h && hasRising) {
triggered1 = true;
if (risingMinute <= 60) msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸€å°æ™‚å…§æœ‰é›¨`;
else if (risingMinute <= 120) msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„å…©å°æ™‚å…§æœ‰é›¨`;
else msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸‰å°æ™‚å…§æœ‰é›¨`;
}

if (!triggered1) {
for (let start = 0; start <= rains.length - 30; start++) {
const window = rains.slice(start, start + 30);
const maxVal = Math.max(...window);
const minVal = Math.min(...window);
if (maxVal - minVal <= 0.5 && maxVal >= 1.0) {
triggered2 = true;
msg = `ğŸŒ§ ä½ æ‰€åœ¨çš„ä½ç½®é è¨ˆç´„ä¸‰å°æ™‚å…§æœ‰é›¨`;
break;
}
}
}
document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦");
}

// ğŸ”Š èªéŸ³æ’­æ”¾
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

// ğŸ“ å®šä½åˆå§‹åŒ–
function initLocation() {
if (!navigator.geolocation) {
alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
const fallbackLat = 22.3, fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
return;
}
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
console.log("âœ… å–å¾—å®šä½ï¼š", lat, lon);
map.setView([lat, lon], 13);
setMarker(lat, lon);
fetchForecast(lat, lon);
fetchTomorrowAI(lat, lon);
},
err => {
console.warn("âš ï¸ å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®");
const fallbackLat = 22.3, fallbackLon = 114.2;
map.setView([fallbackLat, fallbackLon], 11);
setMarker(fallbackLat, fallbackLon);
fetchForecast(fallbackLat, fallbackLon);
fetchTomorrowAI(fallbackLat, fallbackLon);
},
{ enableHighAccuracy: true }
);
}

// ğŸ§  æç¤ºæ¡†é‚è¼¯
function showIosPromptOnce() {
if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
if (!localStorage.getItem("iosPromptShown")) {
document.getElementById("iosPrompt").style.display = "block";
document.getElementById("iosCloseBtn").onclick = function() {
document.getElementById("iosPrompt").style.display = "none";
localStorage.setItem("iosPromptShown", "1");
};
}
}
}

function showCustomPrompt() {
if (localStorage.getItem("subscribedToRainAlert")) return;
document.getElementById("customPrompt").style.display = "block";
document.getElementById("subscribeBtn").onclick = function() {
OneSignal.push(function() {
OneSignal.showNativePrompt();
});
document.getElementById("customPrompt").style.display = "none";
localStorage.setItem("subscribedToRainAlert", "1");
};
document.getElementById("closeCustomBtn").onclick = function() {
document.getElementById("customPrompt").style.display = "none";
};
}

initLocation();
showIosPromptOnce();
showCustomPrompt();
</script>
</body>
</html>