<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>æœªä¾†é™é›¨æç¤º</title>
</head>
<body>
<div id="rainMsg"></div>

<script>
const API_KEY = "Eff94C5FCuRqlqWKPt0tXwHM1niZNEYh";
const LAT = 22.3, LON = 114.2; // é¦™æ¸¯åº§æ¨™
const THRESHOLD = 1.0; // é–€æª»æ”¹ç‚º 1 mm/hr

fetch(`https://api.tomorrow.io/v4/weather/forecast?location=${LAT},${LON}&timesteps=1m&endTime=+180m&apikey=${API_KEY}`)
.then(res => res.json())
.then(data => {
const minutes = data.timelines.minutely.slice(0, 180); // 0â€“3å°æ™‚å…±180åˆ†é˜
const rains = minutes.map(m => m.values.rainIntensity);

// Debug log: å°å‡ºå…¨éƒ¨é€åˆ†é˜é›¨é‡æ•¸æ“š
console.log("ğŸ” é€åˆ†é˜é›¨é‡ (0â€“3h):", rains);

let msg = "æš«æ™‚æœªè¦‹éœ€è¦æç¤ºã€‚";
let triggered = false;

// -------- æ¢ä»¶1: 0â€“3å°æ™‚å…§ â‰¥ 1 ä¸”æœ‰ä¸Šå‡ --------
const overThreshold = rains.some(r => r >= THRESHOLD);

let hasRising = false;
for (let i = 1; i < rains.length; i++) {
if (rains[i] > rains[i - 1]) {
hasRising = true;
break;
}
}

console.log("æ¢ä»¶1æª¢æŸ¥ â†’ overThreshold:", overThreshold, " hasRising:", hasRising);

if (overThreshold && hasRising) {
msg = `ğŸŒ§ æœªä¾† 0â€“3 å°æ™‚å…§é›¨é‡å°‡é”åˆ° â‰¥${THRESHOLD}mm/hrï¼Œä¸¦å‡ºç¾ä¸Šå‡è¶¨å‹¢ï¼`;
triggered = true;
}

// -------- æ¢ä»¶2: é€£çºŒ30åˆ†é˜ç¶­æŒè¿‘ä¼¼å¹³å‡ (0â€“3å°æ™‚, â‰¥1mm ä¸”æ³¢å¹… â‰¤0.5) --------
if (!triggered) { // âœ… å„ªå…ˆç´šï¼šåªæœƒå–ºæ¢ä»¶1æœªè§¸ç™¼æ™‚é¡¯ç¤º
let hasStable30min = false;
for (let start = 0; start <= rains.length - 30; start++) {
const window = rains.slice(start, start + 30);
const maxVal = Math.max(...window);
const minVal = Math.min(...window);
if (maxVal - minVal <= 0.5 && maxVal >= THRESHOLD) {
hasStable30min = true;
console.log(`æ¢ä»¶2è§¸ç™¼ â†’ ç”±ç¬¬ ${start} åˆ†é˜é–‹å§‹é€£çºŒ30åˆ†é˜ç¶­æŒç©©å®š (ç¯„åœ: ${minVal}â€“${maxVal})`);
break;
}
}
if (hasStable30min) {
msg = "â˜ï¸ ç™¼ç¾æœªä¾†ä¸‰å°æ™‚å…§æœ‰é€£çºŒ30åˆ†é˜ä»¥ä¸Šé›¨é‡ç¶­æŒè¿‘ä¼¼å¹³å‡æ°´å¹³ (â‰¥1mm)ã€‚";
}
}

document.getElementById("rainMsg").innerText = msg;
})
.catch(() => document.getElementById("rainMsg").innerText = "âš ï¸ è³‡æ–™è®€å–å¤±æ•—");
</script>
</body>
</html>