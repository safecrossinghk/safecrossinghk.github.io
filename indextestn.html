<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#ffffff">
<title>ğŸŒ§ï¸ é¦™æ¸¯é™é›¨é å ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
font-family: "Helvetica Neue", Arial, sans-serif;
margin: 0;
padding: 0;
background: #f2f6fc;
color: #333;
text-align: center;
}
h2 {
margin: 15px 0;
font-size: 20px;
color: #333;
}
#map {
height: 280px;
width: 92%;
margin: 0 auto;
border-radius: 8px;
border: 1px solid #ddd;
}
#rain-alert {
margin: 15px auto;
padding: 10px;
width: 92%;
background: #fff;
border-radius: 8px;
text-align: center;
font-size: 16px;
font-weight: bold;
color: #444;
line-height: 1.8em;
white-space: pre-line;
}
.notice {
margin: 15px auto;
padding: 12px;
width: 92%;
background: #fff;
border-radius: 8px;
text-align: left;
font-size: 15px;
line-height: 1.6em;
color: #555;
}
/* iOS æç¤ºå°è©±æ¡† */
#iosPrompt {
display: none;
position: fixed;
bottom: 20px;
left: 50%;
transform: translateX(-50%);
background: rgba(255,255,255,0.95);
border: 1px solid #ccc;
border-radius: 10px;
padding: 12px 15px;
width: 88%;
max-width: 320px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
font-size: 14px;
line-height: 1.5em;
z-index: 9999;
}
#iosPrompt button {
margin-top: 8px;
padding: 6px 12px;
border: none;
border-radius: 6px;
background: #007aff;
color: #fff;
font-size: 14px;
}
</style>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script>
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
});
});
</script>
</head>

<body>
<h2>â˜‚ï¸ é¦™æ¸¯é™é›¨é å ±</h2>
<div id="map"></div>
<div id="rain-alert">â³ æ­£åœ¨è®€å–é å ±è³‡æ–™...</div>

<div class="notice">
æœ¬ç¶²ç«™æä¾›é¦™æ¸¯æœªä¾†åŠå°æ™‚å…§å®šé»çš„é™é›¨é æ¸¬ï¼Œç”¨æˆ¶å¯å³æ™‚å¾—çŸ¥èº«è™•åœ°é»çš„é™é›¨æƒ…æ³ã€‚<br><br>
* ç”¨æˆ¶è«‹å…ˆé–‹å•Ÿç¶²é çš„ä½ç½®åˆ†äº«æˆ–æ‰‹æ©Ÿçš„å®šä½æœå‹™<br>
è³‡æ–™ä¾†æºï¼šé¦™æ¸¯å¤©æ–‡å°
</div>

<!-- iOS Safari æç¤ºæ¡† -->
<div id="iosPrompt">
ğŸ“± å¦‚æœä½ ç”¨ iPhone / iPadï¼š<br>
è«‹å…ˆæŒ‰ Safari åº•éƒ¨çš„ <b>åˆ†äº«</b> æŒ‰éˆ• <br>
âœ å†æ€ <b>åŠ å…¥ä¸»ç•«é¢</b> æ‰å¯æ”¶åˆ°æ¨æ’­é€šçŸ¥ã€‚<br>
<button id="iosCloseBtn">çŸ¥é“äº†</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const workerUrl = 'https://crowdtest8.ctakwah.workers.dev/';

const map = L.map('map').setView([22.3, 114.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let marker;
let rainStatus = 0; // 0 = ç„¡é›¨ï¼Œ1 = å·²æ¨é€é

function setMarker(lat, lon) {
if (marker) map.removeLayer(marker);
marker = L.marker([lat, lon]).addTo(map);
}

function fetchForecast(lat, lon) {
fetch(`${workerUrl}?lat=${lat}&lon=${lon}`)
.then(res => res.json())
.then(data => {
const alertDiv = document.getElementById('rain-alert');
console.log("API å›å‚³è³‡æ–™ï¼š", data);

if (data && typeof data.immediateRain === "number") {
if (data.immediateRain > 2) {
alertDiv.innerText = `âš ï¸ ä½ æ‰€åœ¨çš„ä½ç½®å°‡æœƒæœ‰é›¨`;

if (rainStatus === 0) {
speak("âš ï¸ ä½ é™„è¿‘æœ‰é™é›¨");
sendPush();
rainStatus = 1;
}
} else {
alertDiv.innerText = `â˜ï¸ ä½ æ‰€åœ¨çš„ä½ç½®æš«æ™‚ç„¡é›¨`;
rainStatus = 0;
}
} else {
alertDiv.innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
}
})
.catch(err => {
console.error("è®€å–é å ±éŒ¯èª¤", err);
document.getElementById('rain-alert').innerText = "âš ï¸ ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦";
});
}

function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = 'zh-HK';
speechSynthesis.speak(msg);
}

function sendPush() {
OneSignal.push(function() {
OneSignal.showSlidedownPrompt();
});
}

// iOS Safari åµæ¸¬ + æç¤ºåªé¡¯ç¤ºä¸€æ¬¡
function isIos() {
return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}
function isInStandaloneMode() {
return ('standalone' in window.navigator) && window.navigator.standalone;
}
if (isIos() && !isInStandaloneMode() && !localStorage.getItem("iosPromptDismissed")) {
document.getElementById('iosPrompt').style.display = 'block';
}
document.getElementById("iosCloseBtn").addEventListener("click", function() {
document.getElementById('iosPrompt').style.display = 'none';
localStorage.setItem("iosPromptDismissed", "1");
});

// å–å¾—å®šä½
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(
pos => {
const lat = pos.coords.latitude;
const lon = pos.coords.longitude;
setMarker(lat, lon);
fetchForecast(lat, lon);
setInterval(() => fetchForecast(lat, lon), 120000);
},
err => {
document.getElementById('rain-alert').innerText = "âš ï¸ ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹å…è¨±ä½ç½®å­˜å–";
}
);
} else {
document.getElementById('rain-alert').innerText = "âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½";
}
</script>
</body>
</html>