<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â˜” é™é›¨æ¨æ’­æ¸¬è©¦ (iOS Safari + Worker Debug)</title>

<!-- PWA å¿…è¦è¨­å®š -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

<style>
body { font-family: sans-serif; padding: 20px; }
.ok { color: green; font-weight: bold; }
.warn { color: red; font-weight: bold; }
#debug, #debugBox {
white-space: pre-wrap;
background: #f8f8f8;
padding: 10px;
border: 1px solid #ccc;
margin-top: 10px;
}
button { padding: 8px 16px; font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>
<h2>â˜” é™é›¨æ¨æ’­æ¸¬è©¦ (iOS Safari + Worker Debug)</h2>

<div id="status">æª¢æŸ¥ä¸­...</div>
<p>player_id (UserId)ï¼š<span id="playerId">å°šæœªå–å¾—</span></p>

<button id="sendTest" disabled>ğŸ“¨ æ¸¬è©¦æ¨æ’­</button>
<button id="forceRequest">ğŸ”” å¼·åˆ¶ Request Permission</button>

<h3>Debug è¼¸å‡ºï¼š</h3>
<div id="debug">åˆå§‹åŒ–ä¸­...</div>
<div id="debugBox">Debug info...</div>

<script>
(async () => {
const debugEl = document.getElementById("debug");
const statusEl = document.getElementById("status");
const playerIdEl = document.getElementById("playerId");
const sendBtn = document.getElementById("sendTest");
const forceBtn = document.getElementById("forceRequest");
const debugBox = document.getElementById("debugBox");

let currentPlayerId = null;

function log(msg) {
debugEl.textContent += "\n" + msg;
console.log(msg);
}

// PWA åµæ¸¬
const ua = navigator.userAgent;
const isIOS = /iPhone|iPad|iPod/i.test(ua);
const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
const inStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

log("UA: " + ua);
log("isIOS: " + isIOS + ", isSafari: " + isSafari + ", inStandalone: " + inStandalone);

if (isIOS && isSafari && !inStandalone) {
statusEl.innerHTML = "âš ï¸ è«‹å…ˆå°‡æ­¤é  <b>åŠ å…¥ä¸»ç•«é¢</b>ï¼Œå†ç”±ä¸»ç•«é¢é–‹å•Ÿæ‰å¯è¨‚é–±æ¨æ’­ã€‚";
return;
}

// --- OneSignal åˆå§‹åŒ– ---
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
log("é–‹å§‹åˆå§‹åŒ– OneSignal...");

await OneSignal.init({
appId: "880241cd-cc45-4820-b5ec-a1236b0e3e98",
safari_web_id: "ğŸ‘‰ æ›æˆ OneSignal ç”Ÿæˆå˜… safari_web_id ğŸ‘ˆ"
});

const subs = await OneSignal.User.PushSubscription.getSubscription();
if (subs && subs.id) {
statusEl.innerHTML = "âœ… å·²è¨‚é–±é€šçŸ¥";
playerIdEl.textContent = subs.id;
currentPlayerId = subs.id;
sendBtn.disabled = false;
log("å–å¾— player_id: " + subs.id);
} else {
statusEl.innerHTML = "âŒ å°šæœªè¨‚é–±ï¼Œè«‹å…è¨±é€šçŸ¥";
log("æœªèƒ½å–å¾— player_id");
}

// Debug è¨‚é–±è®ŠåŒ–
OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
console.log("ğŸ”” Subscription change event:", event);
const isSubscribed = await OneSignal.User.PushSubscription.optedIn;
const id = OneSignal.User.PushSubscription.id;
console.log("âœ… isSubscribed:", isSubscribed);
console.log("âœ… player_id (PushSubscription.id):", id);

debugBox.innerHTML += "<br>isSubscribed: " + isSubscribed;
debugBox.innerHTML += "<br>player_id: " + (id ? id : "å°šæœªå–å¾—");

if (id) {
playerIdEl.textContent = id;
currentPlayerId = id;
sendBtn.disabled = false;
}
});

// åˆå§‹ Debug ç‹€æ…‹
const permission = await OneSignal.Notifications.permission;
const isSubscribed = await OneSignal.User.PushSubscription.optedIn;
const id = OneSignal.User.PushSubscription.id;
debugBox.innerHTML += "<br>Permission: " + permission;
debugBox.innerHTML += "<br>isSubscribed: " + isSubscribed;
debugBox.innerHTML += "<br>player_id: " + (id ? id : "å°šæœªå–å¾—");
});

// --- æ¸¬è©¦æ¨æ’­æŒ‰éˆ• ---
sendBtn.addEventListener("click", async () => {
if (!currentPlayerId) {
log("âŒ ç„¡æ³•ç™¼é€ï¼Œå› ç‚ºç„¡ player_id");
return;
}
log("å‘¼å« Worker ç™¼é€é€šçŸ¥çµ¦: " + currentPlayerId);

try {
const res = await fetch("ğŸ‘‰ æ›æˆä½  Cloudflare Worker API URL ğŸ‘ˆ", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
player_id: currentPlayerId,
title: "â˜” æ¸¬è©¦é€šçŸ¥",
message: "é€™æ˜¯ä¸€å€‹ iOS Safari Worker æ¨æ’­æ¸¬è©¦"
})
});

const data = await res.json();
log("Worker å›æ‡‰: " + JSON.stringify(data, null, 2));
} catch (err) {
log("âŒ Worker å‘¼å«å¤±æ•—: " + err);
}
});

// --- å¼·åˆ¶ Request Permission æŒ‰éˆ• ---
forceBtn.addEventListener("click", async () => {
try {
log("ğŸ‘‰ å˜—è©¦å¼·åˆ¶å‘¼å« requestPermission()");
const result = await OneSignal.Notifications.requestPermission();
log("ğŸ”” Permission request result: " + result);
debugBox.innerHTML += "<br>Force Request çµæœ: " + result;
} catch (err) {
log("âŒ Request Permission éŒ¯èª¤: " + err);
}
});
})();
</script>
</body>
</html>