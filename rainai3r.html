<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI + HKO é›¨é‡é å ±</title>
<style>
/* ç°¡æ˜“æ‰‹æ©Ÿå‹å–„æ¨£å¼ */
body{font-family:-apple-system,BlinkMacSystemFont,"PingFang HK","Microsoft JhengHei",sans-serif;background:#f7f9fc;margin:12px}
.card{background:#fff;padding:12px;margin:8px 0;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.06)}
.small{font-size:0.95rem}
#enableVoiceBtn{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:6px;background:#0066cc;color:#fff;border:0}
</style>
</head>
<body>
<div class="card small">AI é æ¸¬é™é›¨æ©Ÿç‡: <strong id="aiProb">--%</strong></div>
<div class="card small">AI é è¨ˆé™é›¨é‡: <strong id="aiQpf">-- mm</strong></div>
<div class="card small">å¤©æ–‡å°åŠå°æ™‚é›¨é‡: <strong id="hkoRain">-- mm</strong></div>
<div class="card small">å¤©æ°£ç‹€æ³: <strong id="weather">--</strong></div>

<button id="enableVoiceBtn">å•Ÿç”¨èªéŸ³ï¼ˆæŒ‰ä¸€æ¬¡ä»¥å…è¨±èªéŸ³ï¼‰</button>

<script>
let voiceEnabled = false;
document.getElementById('enableVoiceBtn').addEventListener('click', async ()=>{
try {
const u = new SpeechSynthesisUtterance('èªéŸ³å·²å•Ÿç”¨');
u.lang = 'zh-HK';
speechSynthesis.speak(u);
voiceEnabled = true;
document.getElementById('enableVoiceBtn').style.display = 'none';
} catch (e) {
console.warn('èªéŸ³å•Ÿç”¨å¤±æ•—', e);
voiceEnabled = false;
}
});

function playVoice(text){
if (!voiceEnabled) return console.log('èªéŸ³æœªå•Ÿç”¨ï¼ˆéœ€è¦ç”¨æˆ¶é»æ“Š)');
if (!('speechSynthesis' in window)) return;
const utter = new SpeechSynthesisUtterance(text);
utter.lang = 'zh-HK';
speechSynthesis.speak(utter);
}

async function loadForecast(){
const lat = 22.3027, lon = 114.1772;
try {
const res = await fetch(`https://rainai3r.ctakwah.workers.dev/?lat=${lat}&lon=${lon}&debug=1`);
const data = await res.json();

// AI
const aiProb = data.ai?.pop_percent;
const aiQpf = data.ai?.qpf_mm;

document.getElementById('aiProb').textContent =
(aiProb!==null && aiProb!==undefined) ? aiProb + '%' : '--%';
document.getElementById('aiQpf').textContent =
(aiQpf!==null && aiQpf!==undefined) ? aiQpf.toFixed(1) + ' mm' : '0.0 mm';

// HKO
const hko = data.hko;
if (hko && typeof hko.rain_mm === 'number') {
document.getElementById('hkoRain').textContent = hko.rain_mm.toFixed(1) + ' mm';
if (hko.rain_mm > 5) playVoice(`âš ï¸ å¤©æ–‡å°æç¤ºï¼šåŠå°æ™‚å…§é™é›¨å¯èƒ½è¶…é ${Math.round(hko.rain_mm)} æ¯«ç±³`);
} else if (hko && hko.chosen_station && hko.rain_mm === null) {
document.getElementById('hkoRain').textContent = '-- mmï¼ˆè§£æåˆ°ç«™ ' + (hko.chosen_station || '') + ' ä½†ç„¡é›¨é‡ï¼‰';
} else {
document.getElementById('hkoRain').textContent = '-- mm';
}

// ğŸ“¢ èªéŸ³æ’­å ± AI æ©Ÿç‡ + é›¨é‡
if (aiProb !== null && aiProb >= 50) {
const rainText = (aiQpf && aiQpf > 0) ? `ï¼Œé è¨ˆé™é›¨é‡ ${aiQpf.toFixed(1)} æ¯«ç±³` : '';
playVoice(`æ³¨æ„ï¼šæœªä¾†ä¸€å°æ™‚è½é›¨æ©Ÿç‡ ${aiProb} ç™¾åˆ†æ¯”${rainText}`);
}

// å¤©æ°£ç‹€æ³ï¼ˆå¾ hko æˆ– aiï¼‰
document.getElementById('weather').textContent =
(hko && hko.condition) ? hko.condition : (data.ai?.time ? 'è«‹è¦‹AIè³‡æ–™' : '--');

console.log('DEBUG _debug:', data._debug || 'ï¼ˆç„¡ _debugï¼‰');
} catch (err) {
console.error('è¼‰å…¥å¤±æ•—', err);
}
}
loadForecast();
</script>
</body>
</html>
