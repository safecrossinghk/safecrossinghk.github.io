<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>é¦™æ¸¯é™é›¨æ¨æ’­æ¸¬è©¦ (OneSignal Debug)</title>
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
<style>
body { font-family: Arial, sans-serif; padding: 15px; }
#debug { background: #f7f7f7; padding: 10px; margin-top: 15px; white-space: pre-line; }
input { margin: 5px; }
</style>
</head>
<body>
<h2>â˜” é™é›¨æ¨æ’­æ¸¬è©¦ (Worker + OneSignal Debug)</h2>

<p>OneSignal è¨‚é–±ç‹€æ…‹ï¼š<span id="subStatus">æª¢æŸ¥ä¸­...</span></p>
<p>player_id (userId)ï¼š<input type="text" id="playerIdField" size="40" readonly></p>

<button onclick="checkRain()">æª¢æŸ¥ç•¶å‰ç¶“ç·¯åº¦ä¸¦ç™¼é€æ¨æ’­</button>

<div id="debug">Debug è¼¸å‡ºï¼š</div>

<script>
// åˆå§‹åŒ– OneSignal
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
OneSignal.init({
appId: "ğŸ”‘ä½ çš„-onesignal-app-id", // æ›æˆä½ çš„ appId
safari_web_id: "", // Safari æ‰éœ€è¦ï¼Œå…¶ä»–å¯ç•™ç©º
notifyButton: { enable: true },
allowLocalhostAsSecureOrigin: true
});

// æª¢æŸ¥æ¨æ’­æ˜¯å¦å•Ÿç”¨
OneSignal.isPushNotificationsEnabled(function(isEnabled) {
document.getElementById("subStatus").innerText = isEnabled ? "âœ… å·²å•Ÿç”¨æ¨æ’­" : "âŒ æœªå•Ÿç”¨æ¨æ’­";
});

// å˜—è©¦å–å¾— userId
OneSignal.getUserId().then(function(userId) {
document.getElementById("playerIdField").value = userId || "å°šæœªå–å¾— player id";
log("å–å¾—çš„ player_id: " + userId);
});
});

// Debug log
function log(msg) {
let dbg = document.getElementById("debug");
dbg.innerText += "\n" + new Date().toLocaleTimeString() + " " + msg;
}

// æ¸¬è©¦å‘¼å« Worker
async function checkRain() {
let playerId = document.getElementById("playerIdField").value;
if (!playerId || playerId.includes("å°šæœªå–å¾—")) {
log("âŒ ç„¡æ³•ç™¼é€ï¼Œå› ç‚ºæœªå–å¾— player_id");
return;
}

let lat = 22.32, lon = 114.17; // ä½ å¯ä»¥æ”¹
log("å‘¼å« Workerï¼Œlat=" + lat + " lon=" + lon);

try {
let res = await fetch("https://test3a.ctakwah.workers.dev", {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ lat, lon, player_id: playerId })
});
let data = await res.json();
log("Worker å›æ‡‰: " + JSON.stringify(data));
} catch (e) {
log("âŒ Worker å‘¼å«å¤±æ•—: " + e);
}
}
</script>
</body>
</html>