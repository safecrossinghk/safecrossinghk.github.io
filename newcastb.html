<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¦™æ¸¯å³æ™‚å¤©æ°£é›·é”+è‡¨è¿‘é å ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family: 'Noto Sans HK', sans-serif; background-color: #1a202c; color: #e2e8f0; }
#map { height: 512px; border-radius: 0.75rem; border: 2px solid #4a5568; }
.control-panel { background-color: #2d3748; border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; border: 1px solid #4a5568; }
</style>
</head>
<body class="p-4 md:p-8">
<div class="max-w-xl mx-auto">
<header class="text-center mb-6">
<h1 class="text-3xl font-bold text-white">é¦™æ¸¯å³æ™‚å¤©æ°£é›·é”</h1>
<p class="text-gray-400">åœ°åœ–åº•åœ– + é›·é”åœ– + è‡¨è¿‘é™é›¨é å ± + èªéŸ³è­¦å‘Š</p>
</header>

<main>
<!-- Leaflet åœ°åœ– -->
<div id="map" class="shadow-lg"></div>

<!-- æ§åˆ¶é¢æ¿ -->
<div class="control-panel mt-6 shadow-lg">
<div class="space-y-4">
<div>
<label for="opacity-slider" class="block mb-2 text-sm font-medium text-gray-300">é å ±åœ–é€æ˜åº¦</label>
<div class="flex items-center space-x-4">
<span class="text-sm">æ¸…æ™°</span>
<input id="opacity-slider" type="range" min="0" max="1" value="0.5" step="0.05"
class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
<span class="text-sm">é€æ˜</span>
</div>
</div>
<div>
<label class="block mb-2 text-sm font-medium text-gray-300">èªéŸ³æç¤º</label>
<div class="flex items-center space-x-4">
<button id="mute-toggle" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors"><span>ğŸ”Š é–‹å•Ÿ</span></button>
<button id="test-speech" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition-colors">æ¸¬è©¦èªéŸ³</button>
</div>
</div>
<div class="pt-4 border-t border-gray-600 text-sm text-gray-400 space-y-2">
<p>åœ–åƒæ›´æ–°æ™‚é–“: <span id="last-updated" class="font-medium text-gray-200">æ­£åœ¨è¼‰å…¥...</span></p>
<p>å¤©æ°£è­¦å‘Š: <span id="warning-status" class="font-medium text-gray-200">æ­£åœ¨æª¢æŸ¥...</span></p>
</div>
</div>
</div>

<footer class="text-center mt-8 text-xs text-gray-500"><p>è³‡æ–™ä¾†æºï¼šé¦™æ¸¯å¤©æ–‡å°ã€‚æœ¬é é¢åƒ…ä¾›æŠ€è¡“æ¸¬è©¦åŠå€‹äººåƒè€ƒã€‚</p></footer>
</main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
const opacitySlider = document.getElementById('opacity-slider');
const lastUpdatedSpan = document.getElementById('last-updated');
const warningStatusSpan = document.getElementById('warning-status');
const muteToggleBtn = document.getElementById('mute-toggle');
const testSpeechBtn = document.getElementById('test-speech');

let isMuted = false;
let lastWarnings = {};

// åˆå§‹åŒ–åœ°åœ–
const map = L.map('map').setView([22.3, 114.2], 9);
const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap è²¢ç»è€…'
}).addTo(map);

// é›·é” & é å ±åœ– overlayï¼ˆé¦™æ¸¯ç¯„åœå¤§æ¦‚åº§æ¨™ï¼‰
const radarLayer = L.imageOverlay('', [[21.6, 113.6], [22.7, 114.6]]);
const nowcastLayer = L.imageOverlay('', [[21.6, 113.6], [22.7, 114.6]], { opacity: 0.5 });

// åŠ å…¥ Layer Control
const overlays = {
"ğŸŒ§ï¸ é›·é”åœ–": radarLayer,
"â˜” è‡¨è¿‘é å ±åœ–": nowcastLayer
};
L.control.layers(null, overlays).addTo(map);

// èªéŸ³æ’­å ±
function speak(text) {
if (isMuted || !window.speechSynthesis) return;
window.speechSynthesis.cancel();
const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'zh-HK';
window.speechSynthesis.speak(utterance);
}

// æ›´æ–°é›·é” & é å ±åœ–
function updateImages() {
const timestamp = new Date().getTime();
const proxy = "https://newcastb.ctakwah.workers.dev/?url=";

radarLayer.setUrl(`${proxy}https://www.hko.gov.hk/wxinfo/radars/radar256/latest_rad256.jpg?t=${timestamp}`);
nowcastLayer.setUrl(`${proxy}https://www.hko.gov.hk/wxinfo/nowcast/radar_range1/swir_256_dly.gif?t=${timestamp}`);

lastUpdatedSpan.textContent = new Date().toLocaleTimeString('zh-HK');
}

// æª¢æŸ¥å¤©æ°£è­¦å‘Š
async function checkWeatherWarnings() {
try {
const proxy = "https://newcastb.ctakwah.workers.dev/?url=";
const warningUrl = `${proxy}https://data.weather.gov.hk/weather-data/json/WeatherWarningSummary.json?t=${new Date().getTime()}`;
const response = await fetch(warningUrl);
const data = await response.json();
let activeWarnings = [], newWarnings = [];

for (const key in data) {
if (data[key].actionCode && data[key].actionCode !== 'CANCEL') {
const warningName = data[key].name;
activeWarnings.push(warningName);
if (!lastWarnings[warningName]) newWarnings.push(warningName);
}
}

if (activeWarnings.length === 0) {
warningStatusSpan.textContent = 'æ²’æœ‰ç”Ÿæ•ˆçš„è­¦å‘Šã€‚';
warningStatusSpan.style.color = '#a0aec0';
} else {
warningStatusSpan.textContent = activeWarnings.join('ã€');
warningStatusSpan.style.color = '#f56565';
}

if (newWarnings.length > 0) speak(`å¤©æ°£å ±å‘Šï¼šå¤©æ–‡å°ç™¼å‡º ${newWarnings.join('ã€')}ã€‚`);
lastWarnings = {}; activeWarnings.forEach(name => { lastWarnings[name] = true; });
} catch (err) {
warningStatusSpan.textContent = 'æª¢æŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
}
}

// æ§åˆ¶é€æ˜åº¦
opacitySlider.addEventListener('input', e => {
nowcastLayer.setOpacity(e.target.value);
});

// æ§åˆ¶èªéŸ³
muteToggleBtn.addEventListener('click', () => {
isMuted = !isMuted;
muteToggleBtn.innerHTML = isMuted ? '<span>ğŸ”‡ éœéŸ³</span>' : '<span>ğŸ”Š é–‹å•Ÿ</span>';
muteToggleBtn.classList.toggle('bg-red-600', isMuted);
muteToggleBtn.classList.toggle('bg-blue-600', !isMuted);
if (!isMuted) speak('èªéŸ³æç¤ºå·²é–‹å•Ÿ');
});
testSpeechBtn.addEventListener('click', () => { speak('é€™æ˜¯ä¸€å€‹èªéŸ³æ¸¬è©¦ã€‚'); });

// åˆå§‹åŒ–
updateImages(); checkWeatherWarnings();
setInterval(updateImages, 6 * 60 * 1000);
setInterval(checkWeatherWarnings, 60 * 1000);
});
</script>
</body>
</html>