<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<title>é¦™æ¸¯é™é›¨é å ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { display: flex; margin: 0; height: 100vh; font-family: sans-serif; }
#map { flex: 1; }
#chart-container { flex: 1; padding: 20px; }
canvas { max-width: 100%; }
#alert { position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 5px; display: none; }
</style>
</head>
<body>
<div id="map"></div>
<div id="chart-container">
<h2>æœªä¾†24å°æ™‚é å ±</h2>
<canvas id="rainChart"></canvas>
<canvas id="tempChart"></canvas>
</div>
<div id="alert">âš ï¸ å¤§é›¨è­¦å‘Š</div>

<script>
// --- åˆå§‹åŒ–åœ°åœ– ---
const map = L.map('map').setView([22.3, 114.2], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
maxZoom: 19
}).addTo(map);

// --- å¾ Worker æ‹‰æ•¸æ“š ---
async function loadData() {
const res = await fetch("https://raintr3b.ctakwah.workers.dev/"); // Worker Endpoint
const data = await res.json();

console.log("HKO Rain CSV:", data.hko_rain);
console.log("Tomorrow.io Forecast:", data.tomorrow_forecast);

// ç°¡å–®å– Tomorrow.io é™é›¨ & æº«åº¦ (ç¤ºä¾‹)
const hours = data.tomorrow_forecast.timelines.hourly.map(x => x.time.slice(11,16));
const rain = data.tomorrow_forecast.timelines.hourly.map(x => x.values.precipitationIntensity);
const temp = data.tomorrow_forecast.timelines.hourly.map(x => x.values.temperature);

renderCharts(hours, rain, temp);

// ğŸš¨ å¦‚æœå¤§é›¨ > 5mm
if (Math.max(...rain) > 5) {
document.getElementById("alert").style.display = "block";
speak("æ³¨æ„ï¼Œå¤§é›¨è­¦å‘Šï¼Œæœªä¾†ä¸€å°æ™‚å¯èƒ½å‡ºç¾å¼·é™é›¨ã€‚");
}

// åœ°åœ–ç¤ºç¯„ï¼šåŠ ä¸€å€‹ marker
L.marker([22.3, 114.2]).addTo(map).bindPopup("é¦™æ¸¯ä¸­å¿ƒé»");
}

// --- ç¹ªè£½åœ–è¡¨ ---
function renderCharts(hours, rain, temp) {
new Chart(document.getElementById("rainChart"), {
type: 'bar',
data: {
labels: hours,
datasets: [{ label: "é™é›¨é‡ (mm)", data: rain }]
}
});

new Chart(document.getElementById("tempChart"), {
type: 'line',
data: {
labels: hours,
datasets: [{ label: "æº«åº¦ (Â°C)", data: temp }]
}
});
}

// --- èªéŸ³æç¤º ---
function speak(text) {
const msg = new SpeechSynthesisUtterance(text);
msg.lang = "zh-HK"; // ç²µèª
speechSynthesis.speak(msg);
}

loadData();
</script>
</body>
</html>