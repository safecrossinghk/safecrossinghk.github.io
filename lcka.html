<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>é«˜å¾·ç´…ç¶ ç‡ˆå€’æ•¸ä¼°ç®—ï¼ˆCloudflare Workerï¼‰</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=c739c1ac829fc2acf00599662cca95f9"></script>
<style>
html, body, #map { width:100%; height:100%; margin:0; padding:0; }
.info-box {
position: absolute;
top: 10px; left: 10px;
background: rgba(255,255,255,0.9);
padding: 10px 15px; border-radius: 8px;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
font-family: Arial; font-size: 14px; line-height: 1.6em;
}
</style>
</head>

<body>
<div id="map"></div>
<div class="info-box" id="info">ğŸš¦ è¼‰å…¥ä¸­...</div>

<script>
// === åˆå§‹åŒ–åœ°åœ– ===
const map = new AMap.Map('map', {
zoom: 17,
center: [114.148551, 22.337974] // è”æè§’é“ / é•·è”è¡—äº¤ç•Œ
});

const marker = new AMap.Marker({
position: [114.148551, 22.337974],
title: "ä½ç½® Aï¼šè”æè§’é“è¿‘é•·è”è¡—"
});
map.add(marker);

// === åŸºæœ¬åƒæ•¸è¨­å®š ===
const V_free = 10; // è‡ªç”±æµé€Ÿåº¦ï¼ˆm/s ç´„ 36km/hï¼‰
const D = 120; // è·é›¢è·¯å£è·é›¢ï¼ˆmï¼Œå‡è¨­ï¼‰
const k = 1.3; // èª¿æ•´å› å­

// === è¨ˆç®—ç´…ç¶ ç‡ˆç‹€æ…‹ ===
function estimateSignal(V_realtime) {
const V_mps = V_realtime / 3.6;
if (V_mps <= 0) return {state:"STOP", remain:null};
const T_arrival = D / V_mps;
const delay_ratio = Math.max(0, Math.min(1, 1 - V_mps / V_free));

let state, T_remain;
if (V_mps < 2) {
state = "RED";
T_remain = delay_ratio * T_arrival * k;
} else if (V_mps < 8) {
state = "MAY_CHANGE";
T_remain = delay_ratio * T_arrival;
} else {
state = "GREEN";
T_remain = (1 - delay_ratio) * T_arrival / 2;
}

return {state, remain:Math.round(T_remain)};
}

// === å‘¼å« Cloudflare Worker ===
async function updateTraffic() {
try {
const res = await fetch("https://lcka.ctakwah.workers.dev/road?road_name=è”æè§’é“");
const data = await res.json();

const estimate = estimateSignal(data.speed);
const color = estimate.state === "RED" ? "ğŸ”´"
: estimate.state === "GREEN" ? "ğŸŸ¢" : "ğŸŸ ";

document.getElementById("info").innerHTML = `
<b>${color} é“è·¯ç‹€æ…‹</b><br>
ğŸ›£ï¸ è·¯æ®µï¼š${data.road}<br>
ğŸš— å¹³å‡é€Ÿåº¦ï¼š${data.speed} km/h<br>
ğŸ“Š ç‹€æ…‹ï¼š${data.status}<br>
â±ï¸ é ä¼°å€’æ•¸ï¼š${estimate.remain || '-'} ç§’<br>
ğŸ•’ æ›´æ–°ï¼š${new Date(data.timestamp).toLocaleTimeString()}
`;
} catch (err) {
document.getElementById("info").innerHTML = "âš ï¸ ç„¡æ³•å–å¾—äº¤é€šè³‡æ–™";
}
}

updateTraffic();
setInterval(updateTraffic, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
</script>
</body>
</html>